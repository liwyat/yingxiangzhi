<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>员工数据分析对比</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            success: '#52C41A',
            warning: '#FAAD14',
            danger: '#FF4D4F',
            gray: {
              100: '#F5F7FA',
              200: '#E4E6EB',
              300: '#C9CDD4',
              400: '#86909C',
              500: '#4E5969',
              600: '#272E3B',
              700: '#1D2129',
            }
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          boxShadow: {
            'card': '0 2px 8px rgba(0, 0, 0, 0.08)',
            'card-hover': '0 4px 16px rgba(0, 0, 0, 0.12)',
          }
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .scrollbar-thin {
        scrollbar-width: thin;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .transition-height {
        transition: max-height 0.3s ease-in-out;
      }
      .loading-shimmer {
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
      }
      @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
      }
      .header-checkbox {
        @apply w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary;
      }
      .compare-up {
        @apply text-success font-medium;
      }
      .compare-down {
        @apply text-danger font-medium;
      }
      .sticky-column {
            position: sticky !important;
            left: 0;
            z-index: 10;
            background-color: #F9FAFB;
            border-right: 1px solid #E5E7EB;
            box-shadow: 2px 0 4px rgba(0,0,0,0.1);
            min-width: 8rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
          }
          /* 直接使用固定宽度计算，避免变量计算问题 */
          .sticky-column-1 { left: 0; }
          .sticky-column-2 { left: 8rem; }
          .sticky-column-3 { left: 16rem; }
          .sticky-column-4 { left: 24rem; }
          .sticky-column-5 { left: 32rem; }
          .sticky-column-6 { left: 40rem; }
          .sticky-column-7 { left: 48rem; }
          /* 为内容区域的sticky列添加样式 */
          #resultTableBody td.sticky-column {
            background-color: white;
            z-index: 5;
            box-shadow: 2px 0 4px rgba(0,0,0,0.05);
          }
    }
  </style>
</head>
<body class="bg-gray-100 font-sans text-gray-700 min-h-screen">
  <!-- 顶部导航 -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <i class="fa fa-bar-chart text-primary text-2xl"></i>
        <h1 class="text-xl font-bold text-gray-700">员工数据分析对比</h1>
      </div>
      <div class="text-sm text-gray-500 flex items-center gap-4">
        <span id="lastImportInfo">上次导入：暂无记录</span>
        <button id="clearOldDataBtn" class="text-danger hover:text-danger/80 text-xs">
          <i class="fa fa-trash-o mr-1"></i>清理历史数据
        </button>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6 w-full max-w-none">
    <!-- 加载状态遮罩 -->
    <div id="loadingMask" class="fixed inset-0 bg-black/5 z-50 hidden flex items-center justify-center">
      <div class="bg-white p-6 rounded-lg shadow-lg flex items-center gap-3">
        <div class="w-6 h-6 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
        <span id="loadingText">处理中，请稍候...</span>
      </div>
    </div>

    <!-- 导入区域 -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- 绩效数据表导入 -->
      <div class="bg-white rounded-lg shadow-card p-6 transition-all duration-300 hover:shadow-card-hover">
        <h2 class="text-lg font-semibold mb-4 flex items-center">
          <i class="fa fa-file-excel-o text-success mr-2"></i>绩效数据表导入
        </h2>
        
        <div class="mb-4">
          <button id="downloadPerformanceTemplate" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-md text-sm flex items-center transition-colors">
            <i class="fa fa-download mr-2"></i>下载模板
          </button>
        </div>
        
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-primary transition-colors cursor-pointer" id="performanceDropArea">
          <i class="fa fa-cloud-upload text-4xl text-gray-400 mb-2"></i>
          <p class="text-gray-500 mb-2">拖放绩效数据表格到此处，或点击上传</p>
          <p class="text-xs text-gray-400">支持 .xlsx 格式文件（最大10MB）</p>
          <input type="file" id="performanceFileInput" accept=".xlsx" class="hidden">
        </div>
        
        <div id="weekInputContainer" class="mt-4 hidden">
          <label for="weekInput" class="block text-sm font-medium text-gray-700 mb-1">时间周</label>
          <div class="flex items-center">
            <input type="text" id="weekInput" placeholder="格式：YXXWXX（例如：Y23W05）" 
                  class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
            <button id="confirmWeekBtn" class="ml-2 bg-primary text-white px-4 py-2 rounded-md text-sm hover:bg-primary/90 transition-colors">
              确认上传
            </button>
          </div>
          <p class="text-xs text-gray-500 mt-1">提示：若时间周已存在，将替换原有数据</p>
        </div>
        
        <div id="performanceUploadStatus" class="mt-4 hidden"></div>
      </div>
      
      <!-- 员工花名单导入 -->
      <div class="bg-white rounded-lg shadow-card p-6 transition-all duration-300 hover:shadow-card-hover">
        <h2 class="text-lg font-semibold mb-4 flex items-center">
          <i class="fa fa-users text-primary mr-2"></i>员工花名单导入
        </h2>
        
        <div class="mb-4 flex flex-wrap gap-2">
          <button id="downloadStaffTemplate" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-md text-sm flex items-center transition-colors">
            <i class="fa fa-download mr-2"></i>下载模板
          </button>
          <button id="downloadCurrentStaffBtn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-md text-sm flex items-center transition-colors hidden">
            <i class="fa fa-download mr-2"></i>下载当前花名单
          </button>
        </div>
        
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-primary transition-colors cursor-pointer" id="staffDropArea">
          <i class="fa fa-cloud-upload text-4xl text-gray-400 mb-2"></i>
          <p class="text-gray-500 mb-2">拖放员工花名单到此处，或点击上传</p>
          <p class="text-xs text-gray-400">支持 .xlsx 格式文件（最大5MB）</p>
          <input type="file" id="staffFileInput" accept=".xlsx" class="hidden">
        </div>
        
        <div id="staffUploadStatus" class="mt-4 hidden"></div>
        
        <!-- 花名单更新时间显示 -->
        <div id="staffLastUpdate" class="mt-3 text-sm text-gray-500 italic">
          最新更新时间：暂无记录
        </div>
      </div>
    </section>
    
    <!-- 已导入绩效数据列表 -->
    <section class="bg-white rounded-lg shadow-card p-6 mb-8">
      <h2 class="text-lg font-semibold mb-4 flex items-center">
        <i class="fa fa-history text-gray-600 mr-2"></i>已导入绩效数据
      </h2>
      
      <div id="performanceDataList" class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead>
            <tr>
              <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">时间周</th>
              <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">数据量</th>
              <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">导入时间</th>
              <th class="px-4 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
            </tr>
          </thead>
          <tbody id="performanceTableBody" class="bg-white divide-y divide-gray-200">
            <tr>
              <td colspan="4" class="px-4 py-8 text-center text-gray-500">暂无导入数据</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
    
    <!-- 目标值设置 -->
    <section class="bg-white rounded-lg shadow-card p-6 mb-8">
      <h2 class="text-lg font-semibold mb-4 flex items-center">
        <i class="fa fa-bullseye text-warning mr-2"></i>目标值设置
      </h2>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <label for="satisfactionTarget" class="block text-sm font-medium text-gray-700 mb-1">满意度_剔除R目标值</label>
          <div class="flex items-center">
            <input type="number" id="satisfactionTarget" value="83.5" min="0" max="100" step="0.1"
                  class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
            <span class="ml-2 text-gray-500">%</span>
          </div>
          <p class="text-xs text-gray-500 mt-1">提示：取值范围 0-100</p>
        </div>
        
        <div>
          <label for="resolutionTarget" class="block text-sm font-medium text-gray-700 mb-1">解决率_剔除R目标值</label>
          <div class="flex items-center">
            <input type="number" id="resolutionTarget" value="70" min="0" max="100" step="0.1"
                  class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
            <span class="ml-2 text-gray-500">%</span>
          </div>
          <p class="text-xs text-gray-500 mt-1">提示：取值范围 0-100</p>
        </div>
        
        <div>
          <label for="resolutionSampleTarget" class="block text-sm font-medium text-gray-700 mb-1">解决率样本量目标值</label>
          <div class="flex items-center">
            <input type="number" id="resolutionSampleTarget" value="5" min="0" step="1"
                  class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
            <span class="ml-2 text-gray-500">条</span>
          </div>
          <p class="text-xs text-gray-500 mt-1">提示：取值范围 ≥0 的整数</p>
        </div>
      </div>
      
      <div class="mt-6">
        <button id="generateDataBtn" class="bg-primary hover:bg-primary/90 text-white px-6 py-2.5 rounded-md text-sm font-medium transition-colors flex items-center">
          <i class="fa fa-calculator mr-2"></i>生成绩效数据
        </button>
      </div>
    </section>
    
    <!-- 生成结果展示 -->
    <section class="bg-white rounded-lg shadow-card p-6 mb-8" id="resultSection" style="display: none;">
      <div class="flex flex-col md:flex-row md:items-center justify-between mb-4">
        <h2 class="text-lg font-semibold flex items-center">
          <i class="fa fa-table text-success mr-2"></i>绩效分析结果
        </h2>
        
        <div class="mt-3 md:mt-0 flex gap-2">
          <button id="toggleHeaderSettingsBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-md text-sm flex items-center transition-colors">
            <i class="fa fa-cog mr-2"></i>表头设置
          </button>
          <button id="exportResultBtn" class="bg-success hover:bg-success/90 text-white px-4 py-2 rounded-md text-sm flex items-center transition-colors">
            <i class="fa fa-download mr-2"></i>导出筛选后数据
          </button>
        </div>
      </div>
      
      <!-- 表头设置面板（优化为核心字段筛选） -->
      <div id="headerSettingsPanel" class="mb-6 border rounded-lg p-4 hidden">
        <h3 class="text-sm font-semibold mb-3 flex items-center">
          <i class="fa fa-list-ul mr-2 text-gray-500"></i>表头显示控制（核心字段）
        </h3>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 max-h-60 overflow-y-auto scrollbar-thin p-2" id="headerCheckboxes">
          <!-- 动态生成核心字段复选框 -->
        </div>
        <div class="mt-3 flex justify-end gap-2">
          <button id="selectAllHeadersBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-md text-sm transition-colors">
            全选
          </button>
          <button id="applyHeaderSettingsBtn" class="bg-primary hover:bg-primary/90 text-white px-3 py-1.5 rounded-md text-sm transition-colors">
            应用设置
          </button>
        </div>
      </div>
      
      <!-- 筛选区域 -->
      <div class="mb-6 border rounded-lg p-4">
        <h3 class="text-sm font-semibold mb-3 flex items-center">
          <i class="fa fa-filter mr-2 text-gray-500"></i>筛选条件
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label for="deptFilter" class="block text-xs text-gray-600 mb-1">五级部门</label>
            <input type="text" id="deptFilter" value="SOHO运营四组京喜在线一组" placeholder="请输入部门关键词" class="w-full border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
          </div>
          <div>
            <label for="erpFilter" class="block text-xs text-gray-600 mb-1">ERP账号</label>
            <input type="text" id="erpFilter" placeholder="请输入ERP关键词" class="w-full border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
          </div>
          <div>
            <label for="nameFilter" class="block text-xs text-gray-600 mb-1">姓名</label>
            <input type="text" id="nameFilter" placeholder="请输入姓名关键词" class="w-full border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
          </div>
          <div>
            <label for="groupFilter" class="block text-xs text-gray-600 mb-1">组别</label>
            <input type="text" id="groupFilter" placeholder="请输入组别关键词" class="w-full border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
          </div>
          <div>
            <label for="vSuggestionFilter" class="block text-xs text-gray-600 mb-1">V数建议</label>
            <select id="vSuggestionFilter" class="w-full border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
              <option value="">全部</option>
              <option value="建议升V">建议升V</option>
              <option value="建议保持">建议保持</option>
              <option value="建议降V">建议降V</option>
            </select>
          </div>
          <div class="flex items-end gap-2">
            <button id="filterBtn" class="flex-1 bg-primary hover:bg-primary/90 text-white px-3 py-1.5 rounded-md text-sm transition-colors">
              应用筛选
            </button>
            <button id="resetFilterBtn" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-md text-sm transition-colors">
              重置
            </button>
          </div>
        </div>
      </div>
      
      <!-- 排序区域 -->
      <div class="mb-4 flex flex-wrap items-center gap-4">
        <div class="flex items-center">
          <label for="sortField" class="mr-2 text-sm font-medium text-gray-700">排序字段：</label>
          <select id="sortField" class="border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
            <!-- 动态生成排序选项 -->
          </select>
        </div>
        <div class="flex items-center">
          <label for="sortDirection" class="mr-2 text-sm font-medium text-gray-700">排序方向：</label>
          <select id="sortDirection" class="border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
            <option value="desc">从大到小</option>
            <option value="asc">从小到大</option>
          </select>
        </div>
        <button id="sortBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-md text-sm transition-colors">
          应用排序
        </button>
      </div>
      
      <div class="mb-4 text-sm text-gray-500">
        <span>显示最近 <strong id="visibleWeeksCount">5</strong> 周数据，共 <strong id="totalWeeksCount">0</strong> 周</span>
        <button id="toggleWeeksBtn" class="text-primary ml-2 hover:underline">
          <i class="fa fa-chevron-down mr-1"></i>展开全部
        </button>
      </div>
      
      <!-- 表格容器 -->
      <div class="overflow-x-auto overflow-y-auto scrollbar-thin" style="max-height: 600px; position: relative;">
        <table class="min-w-full divide-y divide-gray-200">
          <thead>
            <tr id="resultTableHeader">
              <!-- 表头将通过JS动态生成 -->
            </tr>
          </thead>
          <tbody id="resultTableBody" class="bg-white divide-y divide-gray-200">
          <style>
            /* 加强表头和固定列的不透明性 */
            #resultTableHeader th {
              position: sticky !important;
              background-color: #F9FAFB !important;
              border-collapse: separate !important;
              box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            
            /* 确保表格内容不会穿透表头 */
            #resultTableBody {
              position: relative;
              z-index: 1;
            }
            
            #resultTableBody td {
              background-color: white !important;
              position: relative;
              z-index: 1;
            }
            
            #resultTableBody tr:hover td {
              background-color: #F9FAFB !important;
            }
            
            /* 修复表头与内容的z-index层级关系 */
            .sticky-column {
              position: sticky;
              background-color: #F9FAFB !important;
              z-index: 10 !important;
              box-shadow: 2px 0 4px rgba(0,0,0,0.1);
              overflow: visible;
              transition: box-shadow 0.2s ease;
            }
            
            /* 为内容单元格也添加相同的sticky效果，确保完全对齐 */
            #resultTableBody td.sticky-column {
              position: sticky;
              background-color: white !important;
              z-index: 5 !important;
              box-shadow: 2px 0 4px rgba(0,0,0,0.05);
            }
            
            /* 确保表格布局稳定 */
            table {
              table-layout: fixed;
              width: 100%;
              position: relative;
            }
            
            /* 为表头单元格添加最小宽度，防止压缩 */
            #resultTableHeader th {
              min-width: 8rem;
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
              position: sticky !important;
              box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            
            /* 确保表格容器正确定位 */
            .overflow-x-auto {
              position: relative;
            }
            
            /* 修复表头和内容之间的堆叠顺序 */
            #resultTableHeader {
              position: relative;
              z-index: 20;
            }
            
            #resultTableBody {
              position: relative;
              z-index: 1;
            }
          </style>
            <!-- 表格内容将通过JS动态生成 -->
          </tbody>
        </table>
        <!-- 空状态/加载状态 -->
        <div id="tableEmptyState" class="absolute inset-0 flex items-center justify-center bg-white/80 hidden">
          <p class="text-gray-500">暂无数据</p>
        </div>
      </div>
      
      <!-- 分页控件 -->
      <div class="mt-4 flex flex-col sm:flex-row justify-between items-center gap-3" id="paginationControls">
        <div class="text-sm text-gray-500">
          显示 <span id="currentPageRange">0-0</span> 条，共 <span id="totalItemsCount">0</span> 条
        </div>
        <div class="flex items-center gap-2">
          <button id="prevPageBtn" class="px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <i class="fa fa-chevron-left"></i> 上一页
          </button>
          <div class="flex items-center gap-1" id="pageNumbers">
            <!-- 页码将动态生成 -->
          </div>
          <button id="nextPageBtn" class="px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            下一页 <i class="fa fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </section>
    
    <!-- 组别维度报表 -->
    <section class="bg-white rounded-lg shadow-card p-6 mb-8" id="groupReportSection" style="display: none;">
      <div class="flex flex-col md:flex-row md:items-center justify-between mb-4">
        <h2 class="text-lg font-semibold flex items-center">
          <i class="fa fa-users text-primary mr-2"></i>组别维度报表
        </h2>
        
        <div class="mt-3 md:mt-0 flex flex-wrap gap-2">
          <!-- 筛选控件 -->
          <div class="flex flex-wrap gap-2">
            <select id="groupReportDeptFilter" class="px-3 py-2 border border-gray-300 rounded-md text-sm">
              <option value="">全部五级部门</option>
            </select>
            <select id="groupReportGroupFilter" class="px-3 py-2 border border-gray-300 rounded-md text-sm">
              <option value="">全部组别</option>
            </select>
            <button id="applyGroupReportFilterBtn" class="bg-primary hover:bg-primary/90 text-white px-3 py-2 rounded-md text-sm transition-colors">
              <i class="fa fa-filter mr-1"></i>筛选
            </button>
            <button id="resetGroupReportFilterBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded-md text-sm transition-colors">
              <i class="fa fa-refresh mr-1"></i>重置
            </button>
          </div>
          
          <button id="exportGroupReportBtn" class="bg-success hover:bg-success/90 text-white px-4 py-2 rounded-md text-sm flex items-center transition-colors">
            <i class="fa fa-download mr-2"></i>导出组别数据
          </button>
        </div>
      </div>
      
      <!-- 表格容器 -->
      <div class="overflow-x-auto scrollbar-thin" style="max-height: 600px; position: relative;">
        <table class="min-w-full divide-y divide-gray-200">
          <thead>
            <tr id="groupReportTableHeader">
              <!-- 表头将通过JS动态生成 -->
            </tr>
          </thead>
          <tbody id="groupReportTableBody" class="bg-white divide-y divide-gray-200">
            <!-- 表格内容将通过JS动态生成 -->
          </tbody>
        </table>
        <!-- 空状态 -->
        <div id="groupReportEmptyState" class="absolute inset-0 flex items-center justify-center bg-white/80 hidden">
          <p class="text-gray-500">暂无数据</p>
        </div>
      </div>
    </section>
  </main>

  <footer class="bg-white border-t border-gray-200 py-4">
    <div class="container mx-auto px-4 text-center text-sm text-gray-500">
      <p>员工数据分析对比 &copy; 2025 @liguoping.26</p>
    </div>
  </footer>

  <!-- 通知提示组件 -->
  <div id="notification" class="fixed bottom-4 right-4 px-4 py-3 rounded-md shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center max-w-xs"></div>

  <script>
    // 全局数据存储
    const appData = {
      performanceData: {}, // 按时间周存储的绩效数据 { "Y23W05": { data: [], timestamp: 123456789 } }
      staffData: [],       // 员工花名单数据
      staffLastUpdate: 0,  // 员工花名单最后更新时间戳
      resultData: [],      // 生成的结果数据
      filteredResultData: [], // 筛选后的结果数据
      resultHeaders: [],   // 结果数据的表头
      // 核心字段配置（优化点：按类别分组，而非按周）
      coreFieldGroups: [
        { key: 'base', label: '基础信息', fields: ['ERP账号', '姓名', '客服账号', '五级部门', '组别', '新老员工', 'V数建议'] },
        { key: 'volume', label: '接待量', fieldTemplate: '${week}_接待量' },
        { key: 'volume环比', label: '接待量环比', fieldTemplate: '${week}_接待量_环比' },
        { key: 'satisfaction', label: '满意度', fieldTemplate: '${week}_满意度_剔除R' },
        { key: 'satisfaction环比', label: '满意度环比', fieldTemplate: '${week}_满意度_环比' },
        { key: 'satisfaction样本量', label: '满意度样本量', fieldTemplate: '${week}_评价量_剔除R' },
        { key: 'satisfaction样本量环比', label: '满意度样本量环比', fieldTemplate: '${week}_评价量_剔除R_环比' },
        { key: 'satisfaction影响值', label: '满意度影响值', fieldTemplate: '${week}_满意度影响值' },
        { key: 'satisfaction影响值环比', label: '满意度影响值环比', fieldTemplate: '${week}_满意度影响值_环比' },
        { key: 'resolution', label: '解决率', fieldTemplate: '${week}_解决率_剔除R' },
        { key: 'resolution环比', label: '解决率环比', fieldTemplate: '${week}_解决率_环比' },
        { key: 'resolution样本量', label: '解决率样本量', fieldTemplate: '${week}_解决率总评价量_剔除R' },
        { key: 'resolution样本量环比', label: '解决率样本量环比', fieldTemplate: '${week}_解决率总评价量_剔除R_环比' },
        { key: 'resolution影响值', label: '解决率影响值', fieldTemplate: '${week}_解决率影响值' },
        { key: 'resolution影响值环比', label: '解决率影响值环比', fieldTemplate: '${week}_解决率影响值_环比' }
      ],
      headerVisibility: {}, // 表头可见性设置（按核心字段组存储）
      latestWeek: '',      // 最新的时间周，用于判断V数建议和默认排序
      currentWeeks: [],    // 当前的时间周列表
      currentPage: 1,      // 当前页码
      pageSize: 50,        // 每页显示数量
      totalPages: 0        // 总页数
    };

    // DOM 元素
    const elements = {
      // 加载状态
      loadingMask: document.getElementById('loadingMask'),
      loadingText: document.getElementById('loadingText'),
      tableEmptyState: document.getElementById('tableEmptyState'),
      
      // 数据清理
      clearOldDataBtn: document.getElementById('clearOldDataBtn'),
      
      // 绩效数据导入
      performanceDropArea: document.getElementById('performanceDropArea'),
      performanceFileInput: document.getElementById('performanceFileInput'),
      weekInputContainer: document.getElementById('weekInputContainer'),
      weekInput: document.getElementById('weekInput'),
      confirmWeekBtn: document.getElementById('confirmWeekBtn'),
      performanceUploadStatus: document.getElementById('performanceUploadStatus'),
      downloadPerformanceTemplate: document.getElementById('downloadPerformanceTemplate'),
      
      // 员工花名单导入
      staffDropArea: document.getElementById('staffDropArea'),
      staffFileInput: document.getElementById('staffFileInput'),
      staffUploadStatus: document.getElementById('staffUploadStatus'),
      downloadStaffTemplate: document.getElementById('downloadStaffTemplate'),
      downloadCurrentStaffBtn: document.getElementById('downloadCurrentStaffBtn'),
      staffLastUpdate: document.getElementById('staffLastUpdate'),
      
      // 已导入数据列表
      performanceTableBody: document.getElementById('performanceTableBody'),
      lastImportInfo: document.getElementById('lastImportInfo'),
      
      // 目标值设置
      satisfactionTarget: document.getElementById('satisfactionTarget'),
      resolutionTarget: document.getElementById('resolutionTarget'),
      resolutionSampleTarget: document.getElementById('resolutionSampleTarget'),
      generateDataBtn: document.getElementById('generateDataBtn'),
      
      // 结果展示
      resultSection: document.getElementById('resultSection'),
      resultTableHeader: document.getElementById('resultTableHeader'),
      resultTableBody: document.getElementById('resultTableBody'),
      exportResultBtn: document.getElementById('exportResultBtn'),
      visibleWeeksCount: document.getElementById('visibleWeeksCount'),
      totalWeeksCount: document.getElementById('totalWeeksCount'),
      toggleWeeksBtn: document.getElementById('toggleWeeksBtn'),
      
      // 表头设置（核心字段筛选）
      toggleHeaderSettingsBtn: document.getElementById('toggleHeaderSettingsBtn'),
      headerSettingsPanel: document.getElementById('headerSettingsPanel'),
      headerCheckboxes: document.getElementById('headerCheckboxes'),
      selectAllHeadersBtn: document.getElementById('selectAllHeadersBtn'),
      applyHeaderSettingsBtn: document.getElementById('applyHeaderSettingsBtn'),
      
      // 排序相关
      sortField: document.getElementById('sortField'),
      sortDirection: document.getElementById('sortDirection'),
      sortBtn: document.getElementById('sortBtn'),
      
      // 筛选相关
      deptFilter: document.getElementById('deptFilter'),
      erpFilter: document.getElementById('erpFilter'),
      nameFilter: document.getElementById('nameFilter'),
      groupFilter: document.getElementById('groupFilter'),
      vSuggestionFilter: document.getElementById('vSuggestionFilter'),
      filterBtn: document.getElementById('filterBtn'),
      resetFilterBtn: document.getElementById('resetFilterBtn'),
      
      // 分页相关
      paginationControls: document.getElementById('paginationControls'),
      prevPageBtn: document.getElementById('prevPageBtn'),
      nextPageBtn: document.getElementById('nextPageBtn'),
      pageNumbers: document.getElementById('pageNumbers'),
      currentPageRange: document.getElementById('currentPageRange'),
      totalItemsCount: document.getElementById('totalItemsCount'),
      
      // 通知组件
      notification: document.getElementById('notification'),
      
      // 组别报表相关
      groupReportSection: document.getElementById('groupReportSection'),
      groupReportTableHeader: document.getElementById('groupReportTableHeader'),
      groupReportTableBody: document.getElementById('groupReportTableBody'),
      groupReportEmptyState: document.getElementById('groupReportEmptyState'),
      exportGroupReportBtn: document.getElementById('exportGroupReportBtn'),
      groupReportDeptFilter: document.getElementById('groupReportDeptFilter'),
      groupReportGroupFilter: document.getElementById('groupReportGroupFilter'),
      applyGroupReportFilterBtn: document.getElementById('applyGroupReportFilterBtn'),
      resetGroupReportFilterBtn: document.getElementById('resetGroupReportFilterBtn'),
      groupReportDeptFilter: document.getElementById('groupReportDeptFilter'),
      groupReportGroupFilter: document.getElementById('groupReportGroupFilter'),
      applyGroupReportFilterBtn: document.getElementById('applyGroupReportFilterBtn'),
      resetGroupReportFilterBtn: document.getElementById('resetGroupReportFilterBtn')
    };

    // 工具函数：显示加载状态
    function showLoading(text = '处理中，请稍候...') {
      elements.loadingText.textContent = text;
      elements.loadingMask.classList.remove('hidden');
    }

    // 工具函数：隐藏加载状态
    function hideLoading() {
      elements.loadingMask.classList.add('hidden');
    }

    // 工具函数：防抖处理
    function debounce(func, delay = 300) {
      let timer = null;
      return function(...args) {
        clearTimeout(timer);
        timer = setTimeout(() => {
          func.apply(this, args);
        }, delay);
      };
    }

    // 公共函数：解析百分比值为小数
    function parsePercentageValue(value) {
      if (!value) return 0;
      if (typeof value === 'string' && value.includes('%')) {
        return parseFloat(value.replace('%', '')) / 100 || 0;
      }
      return parseFloat(value) || 0;
    }

    // 公共函数：计算影响值（保留12位小数）
    function calculateImpactValue(actualValue, targetValue, personalCount, totalCount) {
      if (totalCount <= 0) return 0;
      const rawValue = (actualValue - targetValue) * (personalCount / totalCount);
      return parseFloat(rawValue.toFixed(12)); // 保留12位小数
    }

    // 公共函数：格式化影响值为百分比（保留5位小数）
    function formatImpactValue(value) {
      return `${(value * 100).toFixed(5)}%`;
    }

    // 初始化应用
    function initApp() {
      // 从本地存储加载数据
      loadFromLocalStorage();
      // 更新UI显示
      updatePerformanceDataList();
      updateLastImportInfo();
      updateStaffLastUpdate();
      // 绑定事件监听
      bindEventListeners();
    }

    // 从本地存储加载数据
    function loadFromLocalStorage() {
      try {
        const savedPerformance = localStorage.getItem('performanceData');
        const savedStaff = localStorage.getItem('staffData');
        const savedStaffLastUpdate = localStorage.getItem('staffLastUpdate');
        const savedHeaderVisibility = localStorage.getItem('headerVisibility');
        
        if (savedPerformance) {
          appData.performanceData = JSON.parse(savedPerformance);
        }
        
        if (savedStaff) {
          appData.staffData = JSON.parse(savedStaff);
        }
        
        if (savedStaffLastUpdate) {
          appData.staffLastUpdate = parseInt(savedStaffLastUpdate);
        }
        
        if (savedHeaderVisibility) {
          appData.headerVisibility = JSON.parse(savedHeaderVisibility);
        }
      } catch (error) {
        console.error('加载本地数据失败：', error);
        showNotification('本地数据损坏，已重置', 'error');
        // 重置本地存储
        localStorage.removeItem('performanceData');
        localStorage.removeItem('staffData');
        localStorage.removeItem('staffLastUpdate');
        localStorage.removeItem('headerVisibility');
      }
    }

    // 保存数据到本地存储
    function saveToLocalStorage() {
      try {
        localStorage.setItem('performanceData', JSON.stringify(appData.performanceData));
        localStorage.setItem('staffData', JSON.stringify(appData.staffData));
        localStorage.setItem('staffLastUpdate', appData.staffLastUpdate.toString());
        localStorage.setItem('headerVisibility', JSON.stringify(appData.headerVisibility));
        updateLastImportInfo();
        updateStaffLastUpdate();
      } catch (error) {
        console.error('保存本地数据失败：', error);
        showNotification('数据保存失败，可能是存储空间不足', 'error');
      }
    }

    // 清理历史数据（保留最近8周）
    function clearOldData() {
      const weeks = Object.keys(appData.performanceData);
      if (weeks.length <= 8) {
        showNotification('数据量不足8周，无需清理', 'info');
        return;
      }
      
      if (!confirm('确定要清理历史数据吗？将保留最近8周的数据')) {
        return;
      }
      
      // 按时间排序，保留最近8周
      const sortedWeeks = [...weeks].sort((a, b) => {
        return appData.performanceData[b].timestamp - appData.performanceData[a].timestamp;
      });
      
      // 需要删除的周
      const weeksToDelete = sortedWeeks.slice(8);
      weeksToDelete.forEach(week => {
        delete appData.performanceData[week];
      });
      
      saveToLocalStorage();
      updatePerformanceDataList();
      showNotification(`已清理 ${weeksToDelete.length} 周历史数据，保留最近8周`, 'success');
    }

    // 更新最后导入信息
    function updateLastImportInfo() {
      const weeks = Object.keys(appData.performanceData);
      if (weeks.length === 0) {
        elements.lastImportInfo.textContent = '上次导入：暂无记录';
        return;
      }
      
      // 找到最新导入的时间周
      let latestWeek = '';
      let latestTime = 0;
      
      for (const week of weeks) {
        if (appData.performanceData[week].timestamp > latestTime) {
          latestTime = appData.performanceData[week].timestamp;
          latestWeek = week;
        }
      }
      
      const date = new Date(latestTime);
      const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
      
      elements.lastImportInfo.textContent = `上次导入：${latestWeek}（${formattedDate}）`;
    }

    // 更新员工花名单最后更新时间显示
    function updateStaffLastUpdate() {
      const staffLastUpdateEl = elements.staffLastUpdate;
      const downloadBtn = elements.downloadCurrentStaffBtn;
      
      if (appData.staffLastUpdate > 0 && appData.staffData.length > 0) {
        const date = new Date(appData.staffLastUpdate);
        const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        staffLastUpdateEl.textContent = `最新更新时间：${formattedDate}`;
        downloadBtn.classList.remove('hidden');
      } else {
        staffLastUpdateEl.textContent = '最新更新时间：暂无记录';
        downloadBtn.classList.add('hidden');
      }
    }

    // 绑定事件监听
    function bindEventListeners() {
      // 清理历史数据
      elements.clearOldDataBtn.addEventListener('click', clearOldData);
      
      // 绩效数据拖放上传
      elements.performanceDropArea.addEventListener('click', () => {
        elements.performanceFileInput.click();
      });
      
      elements.performanceFileInput.addEventListener('change', handlePerformanceFileSelect);
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        elements.performanceDropArea.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      ['dragenter', 'dragover'].forEach(eventName => {
        elements.performanceDropArea.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        elements.performanceDropArea.addEventListener(eventName, unhighlight, false);
      });
      
      function highlight() {
        elements.performanceDropArea.classList.add('border-primary', 'bg-primary/5');
      }
      
      function unhighlight() {
        elements.performanceDropArea.classList.remove('border-primary', 'bg-primary/5');
      }
      
      elements.performanceDropArea.addEventListener('drop', handlePerformanceDrop, false);
      
      // 确认时间周并上传
      elements.confirmWeekBtn.addEventListener('click', processPerformanceData);
      
      // 员工花名单拖放上传
      elements.staffDropArea.addEventListener('click', () => {
        elements.staffFileInput.click();
      });
      
      elements.staffFileInput.addEventListener('change', handleStaffFileSelect);
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        elements.staffDropArea.addEventListener(eventName, preventDefaults, false);
      });
      
      ['dragenter', 'dragover'].forEach(eventName => {
        elements.staffDropArea.addEventListener(eventName, highlightStaffArea, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        elements.staffDropArea.addEventListener(eventName, unhighlightStaffArea, false);
      });
      
      function highlightStaffArea() {
        elements.staffDropArea.classList.add('border-primary', 'bg-primary/5');
      }
      
      function unhighlightStaffArea() {
        elements.staffDropArea.classList.remove('border-primary', 'bg-primary/5');
      }
      
      elements.staffDropArea.addEventListener('drop', handleStaffDrop, false);
      
      // 下载模板和当前花名单
      elements.downloadPerformanceTemplate.addEventListener('click', downloadPerformanceTemplate);
      elements.downloadStaffTemplate.addEventListener('click', downloadStaffTemplate);
      elements.downloadCurrentStaffBtn.addEventListener('click', downloadCurrentStaff);
      
      // 生成数据
      elements.generateDataBtn.addEventListener('click', generateResultData);
      
      // 导出结果
      elements.exportResultBtn.addEventListener('click', exportResultData);
      
      // 导出组别报表
      elements.exportGroupReportBtn.addEventListener('click', exportGroupReportData);
      
      // 组别报表筛选相关事件
      elements.applyGroupReportFilterBtn.addEventListener('click', applyGroupReportFilter);
      elements.resetGroupReportFilterBtn.addEventListener('click', resetGroupReportFilter);
      elements.groupReportDeptFilter.addEventListener('change', updateGroupReportGroupOptions);
      
      // 组别报表筛选相关事件
      elements.applyGroupReportFilterBtn.addEventListener('click', applyGroupReportFilter);
      elements.resetGroupReportFilterBtn.addEventListener('click', resetGroupReportFilter);
      elements.groupReportDeptFilter.addEventListener('change', updateGroupReportGroupOptions);
      
      // 切换周数据显示
      elements.toggleWeeksBtn.addEventListener('click', toggleWeeksDisplay);
      
      // 表头设置（核心字段筛选）
      elements.toggleHeaderSettingsBtn.addEventListener('click', toggleHeaderSettingsPanel);
      elements.selectAllHeadersBtn.addEventListener('click', selectAllHeaders);
      elements.applyHeaderSettingsBtn.addEventListener('click', applyHeaderSettings);
      
      // 排序相关（添加防抖）
      elements.sortBtn.addEventListener('click', debounce(applySort));
      
      // 筛选相关（添加防抖）
      elements.filterBtn.addEventListener('click', debounce(applyFilter));
      elements.resetFilterBtn.addEventListener('click', resetFilter);
      
      // 分页相关
      elements.prevPageBtn.addEventListener('click', goToPrevPage);
      elements.nextPageBtn.addEventListener('click', goToNextPage);
    }

    // 处理绩效数据文件拖放
    function handlePerformanceDrop(e) {
      const dt = e.dataTransfer;
      const file = dt.files[0];
      if (file) {
        handlePerformanceFile(file);
      }
    }

    // 处理绩效数据文件选择
    function handlePerformanceFileSelect(e) {
      const file = e.target.files[0];
      if (file) {
        handlePerformanceFile(file);
      }
    }

    // 处理绩效数据文件（添加大小校验）
    let currentPerformanceFile = null;
    function handlePerformanceFile(file) {
      // 文件大小校验（最大10MB）
      if (file.size > 10 * 1024 * 1024) {
        showNotification('文件大小不能超过10MB', 'error');
        return;
      }
      
      if (!file.name.endsWith('.xlsx')) {
        showNotification('请上传.xlsx格式的文件', 'error');
        return;
      }
      
      currentPerformanceFile = file;
      
      // 显示时间周输入框
      elements.weekInputContainer.classList.remove('hidden');
      elements.weekInput.focus();
      
      // 显示上传状态
      elements.performanceUploadStatus.classList.remove('hidden');
      elements.performanceUploadStatus.innerHTML = `
        <div class="text-sm text-gray-600">已选择文件：${file.name}（${(file.size / 1024 / 1024).toFixed(2)}MB）</div>
      `;
    }

    // 处理员工花名单文件拖放
    function handleStaffDrop(e) {
      const dt = e.dataTransfer;
      const file = dt.files[0];
      if (file) {
        handleStaffFile(file);
      }
    }

    // 处理员工花名单文件选择
    function handleStaffFileSelect(e) {
      const file = e.target.files[0];
      if (file) {
        handleStaffFile(file);
      }
    }

    // 处理员工花名单文件（添加大小校验）
    function handleStaffFile(file) {
      // 文件大小校验（最大5MB）
      if (file.size > 5 * 1024 * 1024) {
        showNotification('文件大小不能超过5MB', 'error');
        return;
      }
      
      if (!file.name.endsWith('.xlsx')) {
        showNotification('请上传.xlsx格式的文件', 'error');
        return;
      }
      
      showLoading('解析文件中...');
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          
          // 验证表头 - 所属行政处、账号、客服姓名
          if (jsonData.length > 0) {
            const keys = Object.keys(jsonData[0]);
            const requiredHeaders = ['所属行政处', '账号', '客服姓名'];
            const missingHeaders = requiredHeaders.filter(header => !keys.includes(header));
            
            if (missingHeaders.length > 0) {
              showNotification(`员工花名单格式不正确，缺少表头：${missingHeaders.join(', ')}`, 'error');
              return;
            }
          }
          
          appData.staffData = jsonData;
          appData.staffLastUpdate = new Date().getTime(); // 更新最后更新时间戳
          saveToLocalStorage();
          
          showNotification(`员工花名单导入成功，共 ${jsonData.length} 条记录`, 'success');
          
          // 更新上传状态
          elements.staffUploadStatus.classList.remove('hidden');
          elements.staffUploadStatus.innerHTML = `
            <div class="text-sm text-success flex items-center">
              <i class="fa fa-check-circle mr-1"></i> 导入成功：${file.name}（${jsonData.length}条记录）
            </div>
          `;
        } catch (error) {
          console.error('处理员工花名单出错：', error);
          showNotification('文件解析错误，请检查文件格式', 'error');
        } finally {
          hideLoading();
        }
      };
      
      reader.readAsArrayBuffer(file);
    }

    // 下载当前员工花名单
    function downloadCurrentStaff() {
      if (appData.staffData.length === 0) {
        showNotification('没有可下载的员工花名单数据', 'warning');
        return;
      }
      
      showLoading('准备下载文件...');
      
      try {
        // 创建工作簿
        const worksheet = XLSX.utils.json_to_sheet(appData.staffData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, '员工花名单');
        
        // 生成文件名（包含最后更新时间）
        const date = new Date(appData.staffLastUpdate);
        const formattedDate = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
        const fileName = `员工花名单_${formattedDate}.xlsx`;
        
        XLSX.writeFile(workbook, fileName);
        showNotification('员工花名单下载成功', 'success');
      } catch (error) {
        console.error('下载员工花名单失败：', error);
        showNotification('文件下载失败，请重试', 'error');
      } finally {
        hideLoading();
      }
    }

    // 处理绩效数据上传（添加数据校验）
    function processPerformanceData() {
      const weekValue = elements.weekInput.value.trim();
      
      // 验证时间周格式
      if (!/^Y\d{2}W\d{2}$/.test(weekValue)) {
        showNotification('时间周格式不正确，请使用YXXWXX格式（例如：Y23W05）', 'error');
        elements.weekInput.focus();
        return;
      }
      
      if (!currentPerformanceFile) {
        showNotification('请先选择绩效数据文件', 'error');
        return;
      }
      
      showLoading('解析并上传数据中...');
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          
          // 验证表头
          if (jsonData.length > 0) {
            const requiredHeaders = [
              '五级部门', '新老员工', 'ERP账号', '客服账号', '接待量', 
              '满意度_剔除R', '解决率_剔除R',
              '满意量_剔除R', '评价量_剔除R', '已解决量_剔除R', '解决率总评价量_剔除R'
            ];
            
            const keys = Object.keys(jsonData[0]);
            const missingHeaders = requiredHeaders.filter(header => !keys.includes(header));
            
            if (missingHeaders.length > 0) {
              showNotification(`绩效数据表格式不正确，缺少表头：${missingHeaders.join(', ')}`, 'error');
              return;
            }
            
            // 数据内容校验（数值范围）
            const invalidRows = [];
            jsonData.forEach((item, index) => {
              const rowNum = index + 2; // 表格行号从2开始（表头+1）
              
              // 接待量不能为负数
              if (parseFloat(item['接待量'] || 0) < 0) {
                invalidRows.push(`第${rowNum}行：接待量不能为负数`);
              }
              
              // 满意度需在0-100之间
              const satisfaction = parsePercentageValue(item['满意度_剔除R']);
              if (satisfaction < 0 || satisfaction > 1) {
                invalidRows.push(`第${rowNum}行：满意度需在0-100%之间`);
              }
              
              // 解决率需在0-100之间
              const resolution = parsePercentageValue(item['解决率_剔除R']);
              if (resolution < 0 || resolution > 1) {
                invalidRows.push(`第${rowNum}行：解决率需在0-100%之间`);
              }
            });
            
            if (invalidRows.length > 0) {
              const errorMsg = `数据校验失败（共${invalidRows.length}处错误）：\n${invalidRows.slice(0, 5).join('\n')}${invalidRows.length > 5 ? '\n...还有更多错误' : ''}`;
              showNotification(errorMsg, 'error');
              return;
            }
          }
          
          // 保存数据
          appData.performanceData[weekValue] = {
            data: jsonData,
            timestamp: new Date().getTime()
          };
          
          saveToLocalStorage();
          updatePerformanceDataList();
          
          showNotification(`绩效数据（${weekValue}）导入成功，共 ${jsonData.length} 条记录`, 'success');
          
          // 重置输入
          elements.weekInputContainer.classList.add('hidden');
          elements.weekInput.value = '';
          currentPerformanceFile = null;
          
          // 更新上传状态
          elements.performanceUploadStatus.innerHTML = `
            <div class="text-sm text-success flex items-center">
              <i class="fa fa-check-circle mr-1"></i> 导入成功：${currentPerformanceFile?.name || ''}（${weekValue}，${jsonData.length}条记录）
            </div>
          `;
        } catch (error) {
          console.error('处理绩效数据出错：', error);
          showNotification('文件解析错误，请检查文件格式', 'error');
        } finally {
          hideLoading();
        }
      };
      
      reader.readAsArrayBuffer(currentPerformanceFile);
    }

    // 更新绩效数据列表（增加下载按钮）
    function updatePerformanceDataList() {
      const weeks = Object.keys(appData.performanceData);
      
      // 按周数排序（提取W后面的数字进行比较）
      weeks.sort((a, b) => {
        const weekA = parseInt(a.split('W')[1]);
        const weekB = parseInt(b.split('W')[1]);
        return weekA - weekB;
      });
      
      if (weeks.length === 0) {
        elements.performanceTableBody.innerHTML = `
          <tr>
            <td colspan="4" class="px-4 py-8 text-center text-gray-500">暂无导入数据</td>
          </tr>
        `;
        return;
      }
      
      let html = '';
      for (const week of weeks) {
        const item = appData.performanceData[week];
        const date = new Date(item.timestamp);
        const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        
        html += `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-4 py-3 whitespace-nowrap">${week}</td>
            <td class="px-4 py-3 whitespace-nowrap">${item.data.length} 条</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formattedDate}</td>
            <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
              <button class="text-primary hover:text-primary/80 transition-colors download-performance mr-3" data-week="${week}">
                <i class="fa fa-download"></i> 下载
              </button>
              <button class="text-danger hover:text-danger/80 transition-colors delete-performance" data-week="${week}">
                <i class="fa fa-trash-o"></i> 删除
              </button>
            </td>
          </tr>
        `;
      }
      
      elements.performanceTableBody.innerHTML = html;
      
      // 绑定下载事件
      document.querySelectorAll('.download-performance').forEach(btn => {
        btn.addEventListener('click', function() {
          const week = this.getAttribute('data-week');
          downloadPerformanceData(week);
        });
      });
      
      // 绑定删除事件
      document.querySelectorAll('.delete-performance').forEach(btn => {
        btn.addEventListener('click', function() {
          const week = this.getAttribute('data-week');
          if (confirm(`确定要删除 ${week} 的绩效数据吗？`)) {
            delete appData.performanceData[week];
            saveToLocalStorage();
            updatePerformanceDataList();
            showNotification(`已删除 ${week} 的绩效数据`, 'info');
          }
        });
      });
    }

    // 下载指定周的绩效数据
    function downloadPerformanceData(week) {
      const weekData = appData.performanceData[week];
      if (!weekData) {
        showNotification('未找到对应的数据', 'error');
        return;
      }
      
      showLoading('正在准备下载文件...');
      
      try {
        // 获取目标值
        const satisfactionTarget = parseFloat(elements.satisfactionTarget.value) || 83.5;
        const resolutionTarget = parseFloat(elements.resolutionTarget.value) || 70;
        const resolutionSampleTarget = parseInt(elements.resolutionSampleTarget.value) || 5;
        
        // 计算当前周的总评价量和总解决率评价量（仅基于当前周数据）
        let totalEvaluationCount = 0;
        let totalResolutionEvaluationCount = 0;
        
        weekData.data.forEach(item => {
          totalEvaluationCount += parseFloat(item['评价量_剔除R'] || 0);
          totalResolutionEvaluationCount += parseFloat(item['解决率总评价量_剔除R'] || 0);
        });
        
        // 处理每条数据，添加新字段
        const processedData = weekData.data.map(item => {
          // 从员工花名单匹配姓名和组别（通过客服账号匹配）
          const staffInfo = appData.staffData.find(staff => staff['账号'] === item['客服账号']) || {};
          
          // 解析原始值
          const satisfaction = parsePercentageValue(item['满意度_剔除R']);
          const resolutionRate = parsePercentageValue(item['解决率_剔除R']);
          
          // 计算影响值（保留12位小数）
          const evaluationCount = parseFloat(item['评价量_剔除R'] || 0);
          const resolutionEvaluationCount = parseFloat(item['解决率总评价量_剔除R'] || 0);
          
          const satisfactionImpact = calculateImpactValue(
            satisfaction, 
            satisfactionTarget / 100, 
            evaluationCount, 
            totalEvaluationCount
          );
          
          const resolutionImpact = calculateImpactValue(
            resolutionRate, 
            resolutionTarget / 100, 
            resolutionEvaluationCount, 
            totalResolutionEvaluationCount
          );
          
          // 构建新数据对象
          const newItem = { ...item };
          newItem['姓名'] = staffInfo['客服姓名'] || '';
          newItem['组别'] = staffInfo['所属行政处'] || '';
          newItem['满意度_剔除R影响值'] = satisfactionImpact; // 原始值（12位）
          newItem['解决率_剔除R影响值'] = resolutionImpact; // 原始值（12位）
          
          return newItem;
        });
        
        // 创建工作簿并导出
        const worksheet = XLSX.utils.json_to_sheet(processedData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, `绩效数据_${week}`);
        
        const fileName = `绩效数据_${week}_带影响值.xlsx`;
        XLSX.writeFile(workbook, fileName);
        
        showNotification(`${week} 绩效数据下载成功，已包含姓名、组别和影响值`, 'success');
      } catch (error) {
        console.error('下载绩效数据失败：', error);
        showNotification('文件下载失败，请重试', 'error');
      } finally {
        hideLoading();
      }
    }

    // 下载绩效数据模板
    function downloadPerformanceTemplate() {
      const headers = [
        '五级部门', '新老员工', 'ERP账号', '客服账号', '接待量',
        '满意度_剔除R', '解决率_剔除R',
        '满意量_剔除R', '评价量_剔除R', '已解决量_剔除R', '解决率总评价量_剔除R'
      ];
      
      const worksheet = XLSX.utils.aoa_to_sheet([headers]);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, '绩效数据模板');
      
      XLSX.writeFile(workbook, '绩效数据模板.xlsx');
    }

    // 下载员工花名单模板
    function downloadStaffTemplate() {
      const headers = ['所属行政处', '账号', '客服姓名'];
      
      const worksheet = XLSX.utils.aoa_to_sheet([headers]);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, '员工花名单模板');
      
      XLSX.writeFile(workbook, '员工花名单模板.xlsx');
    }

    // 生成结果数据（核心优化点：使用核心字段组定义）
    function generateResultData() {
      // 检查是否有绩效数据
      const weeks = Object.keys(appData.performanceData);
      if (weeks.length === 0) {
        showNotification('请先导入绩效数据', 'warning');
        return;
      }
      
      // 检查是否有员工数据
      if (appData.staffData.length === 0) {
        if (!confirm('尚未导入员工花名单，将使用系统默认值（上次导入的数据）。是否继续？')) {
          return;
        }
      }
      
      showLoading('正在生成绩效数据...');
      
      try {
        // 获取目标值
        const satisfactionTarget = parseFloat(elements.satisfactionTarget.value) || 83.5;
        const resolutionTarget = parseFloat(elements.resolutionTarget.value) || 70;
        const resolutionSampleTarget = parseInt(elements.resolutionSampleTarget.value) || 5;
        
        // 按周数排序绩效数据
        const sortedWeeks = [...weeks].sort((a, b) => {
          const weekA = parseInt(a.split('W')[1]);
          const weekB = parseInt(b.split('W')[1]);
          return weekA - weekB;
        });
        
        // 记录当前时间周列表和最新的一周
        appData.currentWeeks = sortedWeeks;
        appData.latestWeek = sortedWeeks[sortedWeeks.length - 1];
        
        // 创建结果数据结构
        const resultData = {};
        
        // 为每个员工初始化数据
        appData.staffData.forEach(staff => {
          const erpAccount = staff['ERP账号'];
          
          if (erpAccount) {
            resultData[erpAccount] = {
              'ERP账号': erpAccount,
              '姓名': staff['姓名'] || '',
              '组别': staff['组别'] || '',
              '五级部门': '',
              '新老员工': '',
              '客服账号': '',
              'V数建议': ''
            };
          }
        });
        
        // 处理每周数据
        for (const weekIndex in sortedWeeks) {
          const week = sortedWeeks[weekIndex];
          const weekData = appData.performanceData[week].data;
          const prevWeek = sortedWeeks[parseInt(weekIndex) - 1]; // 上周数据
          
          // 计算每周的总评价量和总解决率评价量
          let totalEvaluationCount = 0;
          let totalResolutionEvaluationCount = 0;
          
          weekData.forEach(item => {
            totalEvaluationCount += parseFloat(item['评价量_剔除R'] || 0);
            totalResolutionEvaluationCount += parseFloat(item['解决率总评价量_剔除R'] || 0);
          });
          
          // 处理每个员工的数据
          weekData.forEach(item => {
            const erpAccount = item['ERP账号'];
            
            // 如果员工不在结果数据中，则创建新条目
            if (!resultData[erpAccount]) {
              // 尝试从员工花名单中通过客服账号查找
              const staffInfo = appData.staffData.find(staff => staff['账号'] === item['客服账号']);
              
              resultData[erpAccount] = {
                'ERP账号': erpAccount,
                '姓名': staffInfo ? staffInfo['客服姓名'] || '' : '',
                '组别': staffInfo ? staffInfo['所属行政处'] || '' : '',
                '五级部门': item['五级部门'] || '',
                '新老员工': item['新老员工'] || '',
                '客服账号': item['客服账号'] || '',
                'V数建议': ''
              };
            } else {
              // 更新基本信息（如果尚未设置）
              if (!resultData[erpAccount]['五级部门']) {
                resultData[erpAccount]['五级部门'] = item['五级部门'] || '';
              }
              if (!resultData[erpAccount]['新老员工']) {
                resultData[erpAccount]['新老员工'] = item['新老员工'] || '';
              }
              if (!resultData[erpAccount]['客服账号']) {
                resultData[erpAccount]['客服账号'] = item['客服账号'] || '';
                
                // 如果刚设置了客服账号，尝试从花名单中获取姓名和组别信息
                if (item['客服账号']) {
                  const staffInfo = appData.staffData.find(staff => staff['账号'] === item['客服账号']);
                  if (staffInfo) {
                    resultData[erpAccount]['姓名'] = staffInfo['客服姓名'] || '';
                    resultData[erpAccount]['组别'] = staffInfo['所属行政处'] || '';
                  }
                }
              }
            }
            
            // 解析原始值
            const satisfaction = parsePercentageValue(item['满意度_剔除R']);
            const resolutionRate = parsePercentageValue(item['解决率_剔除R']);
            const 接待量 = parseFloat(item['接待量'] || 0);
            
            // 提取新增字段
            const 满意量_剔除R = parseFloat(item['满意量_剔除R'] || 0);
            const 评价量_剔除R = parseFloat(item['评价量_剔除R'] || 0);
            const 已解决量_剔除R = parseFloat(item['已解决量_剔除R'] || 0);
            const 解决率总评价量_剔除R = parseFloat(item['解决率总评价量_剔除R'] || 0);
            
            // 计算影响值（保留12位小数）
            const satisfactionImpact = calculateImpactValue(
              satisfaction, 
              satisfactionTarget / 100, 
              评价量_剔除R, 
              totalEvaluationCount
            );
            
            const resolutionImpact = calculateImpactValue(
              resolutionRate, 
              resolutionTarget / 100, 
              解决率总评价量_剔除R, 
              totalResolutionEvaluationCount
            );
            
            // 存储每周数据（按核心字段模板生成字段名）
            resultData[erpAccount][`${week}_接待量`] = 接待量;
            resultData[erpAccount][`${week}_满意度_剔除R`] = `${(satisfaction * 100).toFixed(2)}%`;
            resultData[erpAccount][`${week}_满意度_原始值`] = satisfaction; // 用于排序和比较
            resultData[erpAccount][`${week}_评价量_剔除R`] = 评价量_剔除R;
            resultData[erpAccount][`${week}_满意量_剔除R`] = 满意量_剔除R; // 添加满意量字段存储
            resultData[erpAccount][`${week}_满意度影响值`] = satisfactionImpact;
            
            resultData[erpAccount][`${week}_解决率_剔除R`] = `${(resolutionRate * 100).toFixed(2)}%`;
            resultData[erpAccount][`${week}_解决率_原始值`] = resolutionRate; // 用于排序和比较
            resultData[erpAccount][`${week}_解决率总评价量_剔除R`] = 解决率总评价量_剔除R;
            resultData[erpAccount][`${week}_已解决量_剔除R`] = 已解决量_剔除R; // 添加已解决量字段存储
            resultData[erpAccount][`${week}_解决率影响值`] = resolutionImpact;
            
            // 计算与上周的对比（如果有上周数据）
            if (prevWeek && resultData[erpAccount][`${prevWeek}_接待量`] !== undefined) {
              // 接待量对比
              const prevVolume = resultData[erpAccount][`${prevWeek}_接待量`];
              const volumeDiff = 接待量 - prevVolume;
              const volumeDiffRate = prevVolume > 0 ? (volumeDiff / prevVolume) : 0;
              resultData[erpAccount][`${week}_接待量_环比`] = {
                diff: volumeDiff,
                rate: volumeDiffRate
              };
              
              // 满意度对比
              const prevSatisfaction = resultData[erpAccount][`${prevWeek}_满意度_原始值`];
              const satisfactionDiff = satisfaction - prevSatisfaction;
              const satisfactionDiffRate = prevSatisfaction > 0 ? (satisfactionDiff / prevSatisfaction) : 0;
              resultData[erpAccount][`${week}_满意度_环比`] = {
                diff: satisfactionDiff,
                rate: satisfactionDiffRate,
                displayDiff: `${(satisfactionDiff * 100).toFixed(2)}%`
              };
              
              // 满意度样本量环比
              const prevEvaluationCount = resultData[erpAccount][`${prevWeek}_评价量_剔除R`] || 0;
              const evaluationCountDiff = 评价量_剔除R - prevEvaluationCount;
              const evaluationCountDiffRate = prevEvaluationCount > 0 ? (evaluationCountDiff / prevEvaluationCount) : 0;
              resultData[erpAccount][`${week}_评价量_剔除R_环比`] = {
                diff: evaluationCountDiff,
                rate: evaluationCountDiffRate
              };
              
              // 满意度影响值环比
              const prevSatisfactionImpact = resultData[erpAccount][`${prevWeek}_满意度影响值`] || 0;
              const satisfactionImpactDiff = satisfactionImpact - prevSatisfactionImpact;
              const satisfactionImpactDiffRate = prevSatisfactionImpact !== 0 ? (satisfactionImpactDiff / prevSatisfactionImpact) : 0;
              resultData[erpAccount][`${week}_满意度影响值_环比`] = {
                diff: satisfactionImpactDiff,
                rate: satisfactionImpactDiffRate,
                displayDiff: formatImpactValue(satisfactionImpactDiff)
              };
              
              // 解决率对比
              const prevResolution = resultData[erpAccount][`${prevWeek}_解决率_原始值`];
              const resolutionDiff = resolutionRate - prevResolution;
              const resolutionDiffRate = prevResolution > 0 ? (resolutionDiff / prevResolution) : 0;
              resultData[erpAccount][`${week}_解决率_环比`] = {
                diff: resolutionDiff,
                rate: resolutionDiffRate,
                displayDiff: `${(resolutionDiff * 100).toFixed(2)}%`
              };
              
              // 解决率样本量环比
              const prevResolutionEvaluationCount = resultData[erpAccount][`${prevWeek}_解决率总评价量_剔除R`] || 0;
              const resolutionEvaluationCountDiff = 解决率总评价量_剔除R - prevResolutionEvaluationCount;
              const resolutionEvaluationCountDiffRate = prevResolutionEvaluationCount > 0 ? (resolutionEvaluationCountDiff / prevResolutionEvaluationCount) : 0;
              resultData[erpAccount][`${week}_解决率总评价量_剔除R_环比`] = {
                diff: resolutionEvaluationCountDiff,
                rate: resolutionEvaluationCountDiffRate
              };
              
              // 解决率影响值环比
              const prevResolutionImpact = resultData[erpAccount][`${prevWeek}_解决率影响值`] || 0;
              const resolutionImpactDiff = resolutionImpact - prevResolutionImpact;
              const resolutionImpactDiffRate = prevResolutionImpact !== 0 ? (resolutionImpactDiff / prevResolutionImpact) : 0;
              resultData[erpAccount][`${week}_解决率影响值_环比`] = {
                diff: resolutionImpactDiff,
                rate: resolutionImpactDiffRate,
                displayDiff: formatImpactValue(resolutionImpactDiff)
              };
            }
            
            // 如果是最新一周，计算V数建议
            if (week === appData.latestWeek) {
              if (satisfactionImpact > 0) {
                resultData[erpAccount]['V数建议'] = '建议升V';
              } else if (satisfactionImpact < 0) {
                resultData[erpAccount]['V数建议'] = '建议降V';
              } else {
                resultData[erpAccount]['V数建议'] = '建议保持';
              }
            }
          });
        }
        
        // 转换为数组并保存
        appData.resultData = Object.values(resultData);
        appData.filteredResultData = [...appData.resultData];
        
        // 生成表头（基于核心字段组）
        generateResultHeaders(sortedWeeks);
        
        // 初始化表头可见性（默认全显示）
        initHeaderVisibility();
        
        // 生成表头控制复选框（核心字段组）
        generateHeaderCheckboxes();
        
        // 初始化排序选项
        initSortOptions();
        
        // 重置页码
        appData.currentPage = 1;
        
        // 应用默认排序（最新一周接待量降序）
        applyDefaultSort();
        
        // 应用默认的五级部门筛选
        applyFilter();
        
        // 显示结果
        displayResultData(sortedWeeks);
        
        showNotification('绩效数据生成成功', 'success');
      } catch (error) {
        console.error('生成绩效数据失败：', error);
        showNotification('数据生成失败，请重试', 'error');
      } finally {
        hideLoading();
      }
    }

    // 初始化表头可见性设置（按核心字段组）
    function initHeaderVisibility() {
      // 如果没有保存的设置，默认全显示
      if (Object.keys(appData.headerVisibility).length === 0) {
        appData.coreFieldGroups.forEach(group => {
          appData.headerVisibility[group.key] = true;
        });
      } else {
        // 确保新核心字段组有默认值
        appData.coreFieldGroups.forEach(group => {
          if (appData.headerVisibility[group.key] === undefined) {
            appData.headerVisibility[group.key] = true;
          }
        });
      }
    }

    // 生成表头控制复选框（核心字段组）
    function generateHeaderCheckboxes() {
      elements.headerCheckboxes.innerHTML = '';
      
      appData.coreFieldGroups.forEach(group => {
        const checkboxId = `header_${group.key}`;
        const label = document.createElement('label');
        label.className = 'flex items-center gap-2 cursor-pointer';
        label.innerHTML = `
          <input type="checkbox" id="${checkboxId}" class="header-checkbox" ${appData.headerVisibility[group.key] ? 'checked' : ''}>
          <span class="text-sm">${group.label}</span>
        `;
        label.querySelector('input').setAttribute('data-group', group.key);
        elements.headerCheckboxes.appendChild(label);
      });
    }

    // 切换表头设置面板显示
    function toggleHeaderSettingsPanel() {
      elements.headerSettingsPanel.classList.toggle('hidden');
    }

    // 全选/取消全选表头（核心字段组）
    function selectAllHeaders() {
      const checkboxes = elements.headerCheckboxes.querySelectorAll('input');
      const allChecked = [...checkboxes].every(cb => cb.checked);
      
      checkboxes.forEach(cb => {
        cb.checked = !allChecked;
      });
    }

    // 应用表头设置（核心字段组）
    function applyHeaderSettings() {
      const checkboxes = elements.headerCheckboxes.querySelectorAll('input');
      
      checkboxes.forEach(cb => {
        const groupKey = cb.getAttribute('data-group');
        appData.headerVisibility[groupKey] = cb.checked;
      });
      
      saveToLocalStorage();
      displayResultData(appData.currentWeeks);
      toggleHeaderSettingsPanel();
      showNotification('表头设置已应用', 'success');
    }

    // 初始化排序选项
    function initSortOptions() {
      // 清空现有选项
      elements.sortField.innerHTML = '';
      
      // 添加基础排序字段
      const baseGroup = appData.coreFieldGroups.find(g => g.key === 'base');
      if (baseGroup) {
        baseGroup.fields.forEach(field => {
          const opt = document.createElement('option');
          opt.value = field;
          opt.textContent = field;
          elements.sortField.appendChild(opt);
        });
      }
      
      // 为每个时间周和核心字段组添加排序选项
      appData.currentWeeks.forEach(week => {
        const weekNum = week.split('W')[1];
        
        // 排除基础信息组（已单独处理）
        appData.coreFieldGroups
          .filter(g => g.key !== 'base' && g.fieldTemplate)
          .forEach(group => {
            const field = group.fieldTemplate.replace('${week}', week);
            const opt = document.createElement('option');
            opt.value = field;
            opt.textContent = `周${weekNum}_${group.label}`;
            elements.sortField.appendChild(opt);
          });
      });
    }

    // 应用默认排序（最新一周接待量降序）
    function applyDefaultSort() {
      if (appData.latestWeek) {
        elements.sortField.value = `${appData.latestWeek}_接待量`;
        elements.sortDirection.value = 'desc';
        applySort();
      }
    }

    // 应用排序
    function applySort() {
      const sortField = elements.sortField.value;
      const sortDirection = elements.sortDirection.value;
      
      if (!sortField || appData.filteredResultData.length === 0) return;
      
      // 对筛选后的数据进行排序
      appData.filteredResultData.sort((a, b) => {
        const valueA = a[sortField] !== undefined ? a[sortField] : -Infinity;
        const valueB = b[sortField] !== undefined ? b[sortField] : -Infinity;
        
        // 处理数字比较
        if (typeof valueA === 'number' && typeof valueB === 'number') {
          return sortDirection === 'asc' ? valueA - valueB : valueB - valueA;
        }
        
        // 处理对象类型的环比数据（使用diff进行排序）
        if (typeof valueA === 'object' && typeof valueB === 'object' && 'diff' in valueA && 'diff' in valueB) {
          return sortDirection === 'asc' ? valueA.diff - valueB.diff : valueB.diff - valueA.diff;
        }
        
        // 字符串比较
        return sortDirection === 'asc' 
          ? String(valueA).localeCompare(String(valueB))
          : String(valueB).localeCompare(String(valueA));
      });
      
      // 重置到第一页
      appData.currentPage = 1;
      
      // 重新显示数据
      displayResultData(appData.currentWeeks);
    }

    // 应用筛选
    function applyFilter() {
      const dept = elements.deptFilter.value.trim().toLowerCase();
      const erp = elements.erpFilter.value.trim().toLowerCase();
      const name = elements.nameFilter.value.trim().toLowerCase();
      const group = elements.groupFilter.value.trim().toLowerCase();
      const vSuggestion = elements.vSuggestionFilter.value;
      
      // 快速返回全量数据
      if (!dept && !erp && !name && !group && !vSuggestion) {
        appData.filteredResultData = [...appData.resultData];
      } else {
        // 过滤数据
        appData.filteredResultData = appData.resultData.filter(row => {
          // 短路逻辑优化
          if (dept && !String(row['五级部门'] || '').toLowerCase().includes(dept)) return false;
          if (erp && !String(row['ERP账号'] || '').toLowerCase().includes(erp)) return false;
          if (name && !String(row['姓名'] || '').toLowerCase().includes(name)) return false;
          if (group && !String(row['组别'] || '').toLowerCase().includes(group)) return false;
          if (vSuggestion && row['V数建议'] !== vSuggestion) return false;
          
          return true;
        });
      }
      
      // 重置到第一页
      appData.currentPage = 1;
      
      // 重新应用当前排序
      applySort();
      
      showNotification(`筛选完成，共 ${appData.filteredResultData.length} 条数据`, 'info');
    }

    // 重置筛选条件
    function resetFilter() {
      // 重置时保留五级部门的默认值
      elements.erpFilter.value = '';
      elements.nameFilter.value = '';
      elements.groupFilter.value = '';
      elements.vSuggestionFilter.value = '';
      
      // 恢复所有数据并应用默认的五级部门筛选
      appData.filteredResultData = [...appData.resultData];
      
      // 重置到第一页
      appData.currentPage = 1;
      
      applyFilter();
    }

    // 生成结果表头（基于核心字段组）
    function generateResultHeaders(weeks) {
      const headers = [];
      
      // 处理基础信息组
      const baseGroup = appData.coreFieldGroups.find(g => g.key === 'base');
      if (baseGroup) {
        headers.push(...baseGroup.fields);
      }
      
      // 处理每周的核心字段组
      weeks.forEach(week => {
        appData.coreFieldGroups
          .filter(g => g.key !== 'base' && g.fieldTemplate) // 排除基础信息组
          .forEach(group => {
            const field = group.fieldTemplate.replace('${week}', week);
            headers.push(field);
          });
      });
      
      appData.resultHeaders = headers;
    }

    // 计算分页信息
    function calculatePagination() {
      appData.totalPages = Math.ceil(appData.filteredResultData.length / appData.pageSize);
      
      // 确保当前页在有效范围内
      if (appData.currentPage > appData.totalPages) {
        appData.currentPage = Math.max(1, appData.totalPages);
      }
      
      // 更新分页控件状态
      updatePaginationControls();
    }

    // 更新分页控件
    function updatePaginationControls() {
      // 更新计数显示
      const start = (appData.currentPage - 1) * appData.pageSize + 1;
      const end = Math.min(start + appData.pageSize - 1, appData.filteredResultData.length);
      elements.currentPageRange.textContent = `${start}-${end}`;
      elements.totalItemsCount.textContent = appData.filteredResultData.length;
      
      // 更新按钮状态
      elements.prevPageBtn.disabled = appData.currentPage <= 1;
      elements.nextPageBtn.disabled = appData.currentPage >= appData.totalPages;
      
      // 生成页码
      generatePageNumbers();
    }

    // 生成页码
    function generatePageNumbers() {
      elements.pageNumbers.innerHTML = '';
      
      // 最多显示10个页码
      const maxVisiblePages = 10;
      let startPage = Math.max(1, appData.currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = startPage + maxVisiblePages - 1;
      
      // 调整结束页
      if (endPage > appData.totalPages) {
        endPage = appData.totalPages;
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      // 添加第一页
      if (startPage > 1) {
        addPageNumber(1);
        
        // 添加省略号
        if (startPage > 2) {
          const ellipsis = document.createElement('span');
          ellipsis.className = 'px-2 text-gray-500';
          ellipsis.textContent = '...';
          elements.pageNumbers.appendChild(ellipsis);
        }
      }
      
      // 添加可见页码
      for (let i = startPage; i <= endPage; i++) {
        addPageNumber(i);
      }
      
      // 添加最后一页
      if (endPage < appData.totalPages) {
        // 添加省略号
        if (endPage < appData.totalPages - 1) {
          const ellipsis = document.createElement('span');
          ellipsis.className = 'px-2 text-gray-500';
          ellipsis.textContent = '...';
          elements.pageNumbers.appendChild(ellipsis);
        }
        
        addPageNumber(appData.totalPages);
      }
    }

    // 添加页码
    function addPageNumber(pageNum) {
      const pageBtn = document.createElement('button');
      pageBtn.className = `px-3 py-1 rounded-md text-sm ${
        appData.currentPage === pageNum 
          ? 'bg-primary text-white' 
          : 'border border-gray-300 hover:bg-gray-50'
      }`;
      pageBtn.textContent = pageNum;
      pageBtn.addEventListener('click', () => {
        appData.currentPage = pageNum;
        displayResultData(appData.currentWeeks);
      });
      elements.pageNumbers.appendChild(pageBtn);
    }

    // 上一页
    function goToPrevPage() {
      if (appData.currentPage > 1) {
        appData.currentPage--;
        displayResultData(appData.currentWeeks);
      }
    }

    // 下一页
    function goToNextPage() {
      if (appData.currentPage < appData.totalPages) {
        appData.currentPage++;
        displayResultData(appData.currentWeeks);
      }
    }

    // 更新sticky列位置的函数
    function updateStickyColumnPositions() {
      // 获取表头和内容的sticky列
      const headerStickyColumns = document.querySelectorAll('#resultTableHeader th.sticky-column');
      
      // 为每个sticky列设置CSS变量，动态调整位置
      headerStickyColumns.forEach((col, index) => {
        // 获取前一列的宽度和位置，计算当前列的left值
        let leftPosition = 0;
        if (index > 0) { // 从第二列开始计算
          leftPosition = 0;
          // 累加前面所有列的宽度
          for (let i = 0; i < index; i++) {
            leftPosition += headerStickyColumns[i].offsetWidth;
          }
        }
        
        // 设置CSS变量，用于实际列的定位
        document.documentElement.style.setProperty(`--sticky-col-${index+1}`, `${leftPosition}px`);
        
        // 同时直接更新所有内容行的对应sticky列位置
        const contentColumns = document.querySelectorAll(`#resultTableBody td.sticky-column-${index+1}`);
        contentColumns.forEach(contentCol => {
          contentCol.style.left = `${leftPosition}px`;
        });
      });
    }
    
    // 窗口大小改变或表格滚动时重新计算
    window.addEventListener('resize', updateStickyColumnPositions);
    
    // 显示结果数据（基于核心字段组的可见性）
    let showAllWeeks = false;
    function displayResultData(weeks) {
      // 获取解决率样本量目标值
      const resolutionSampleTarget = parseInt(elements.resolutionSampleTarget.value) || 5;
      
      // 计算分页
      calculatePagination();
      
      // 显示空状态
      if (appData.filteredResultData.length === 0) {
        elements.tableEmptyState.classList.remove('hidden');
        elements.resultTableBody.innerHTML = '';
        return;
      } else {
        elements.tableEmptyState.classList.add('hidden');
      }
      
      // 更新计数显示
      elements.totalWeeksCount.textContent = weeks.length;
      elements.visibleWeeksCount.textContent = Math.min(weeks.length, 5);
      
      // 获取当前页数据
      const startIndex = (appData.currentPage - 1) * appData.pageSize;
      const endIndex = startIndex + appData.pageSize;
      const currentPageData = appData.filteredResultData.slice(startIndex, endIndex);
      
      // 获取目标值
      const satisfactionTarget = parseFloat(elements.satisfactionTarget.value) || 83.5;
      const resolutionTarget = parseFloat(elements.resolutionTarget.value) || 70;
      
      // 生成表头（基于核心字段组的可见性）
      let headerHtml = '';
      // 清空表头内容，确保重新渲染
      elements.resultTableHeader.innerHTML = '';
      
      // 处理基础信息组
      const baseGroup = appData.coreFieldGroups.find(g => g.key === 'base');
      if (baseGroup && appData.headerVisibility[baseGroup.key]) {
        baseGroup.fields.forEach((field, index) => {
          headerHtml += `<th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap sticky top-0 sticky-column sticky-column-${index + 1} border-r border-gray-200 shadow-md" style="z-index: 100; background-color: #F9FAFB !important; border-collapse: separate; min-width: 8rem; position: sticky !important; box-shadow: 0 2px 4px rgba(0,0,0,0.05), 2px 0 4px rgba(0,0,0,0.05);">${field}</th>`;
        });
      }
      
      // 处理每周的核心字段组
      weeks.forEach((week, weekIndex) => {
        const shouldShowWeek = showAllWeeks || weekIndex >= weeks.length - 5;
        const weekClass = shouldShowWeek ? '' : 'hidden extra-week';
        const weekNum = week.split('W')[1];
        
        // 按核心字段组顺序生成表头
        appData.coreFieldGroups
          .filter(g => g.key !== 'base' && g.fieldTemplate && appData.headerVisibility[g.key])
          .forEach(group => {
            const field = group.fieldTemplate.replace('${week}', week);
            headerHtml += `
              <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap ${weekClass} sticky top-0 shadow-md" data-week="${week}" style="z-index: 50; background-color: #F9FAFB !important; border-collapse: separate;">
                ${group.key.includes('环比') ? '环比' : `周${weekNum}_${group.label}`}
              </th>
            `;
          });
      });
      
      elements.resultTableHeader.innerHTML = headerHtml;
      
      // 生成表格内容
      let bodyHtml = '';
      
      currentPageData.forEach((row, rowIndex) => {
        let rowHtml = `<tr class="${rowIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100 transition-colors">`;
        
        // 处理基础信息组
        if (baseGroup && appData.headerVisibility[baseGroup.key]) {
          baseGroup.fields.forEach((field, index) => {
            let cellContent = row[field] || '-';
            let cellClass = `px-3 py-2 text-sm whitespace-nowrap sticky-column sticky-column-${index + 1} bg-white z-1`;
            
            // 为V数建议添加不同的颜色
            if (field === 'V数建议') {
              cellClass += ' font-medium';
              switch(cellContent) {
                case '建议升V':
                  cellClass += ' text-success';
                  break;
                case '建议降V':
                  cellClass += ' text-danger';
                  break;
                case '建议保持':
                  cellClass += ' text-warning';
                  break;
                default:
                  cellClass += ' text-gray-700';
              }
            } else {
              cellClass += ' text-gray-700';
            }
            
            rowHtml += `<td class="${cellClass}">${cellContent}</td>`;
          });
        }
        
        // 处理每周的核心字段组数据
        weeks.forEach((week, weekIndex) => {
          const shouldShowWeek = showAllWeeks || weekIndex >= weeks.length - 5;
          const weekClass = shouldShowWeek ? '' : 'hidden extra-week';
          
          // 按核心字段组顺序生成数据单元格
          appData.coreFieldGroups
            .filter(g => g.key !== 'base' && g.fieldTemplate && appData.headerVisibility[g.key])
            .forEach(group => {
              const field = group.fieldTemplate.replace('${week}', week);
              const value = row[field];
              
              // 根据字段类型渲染不同内容
              let cellContent = '-';
              
              switch(group.key) {
                case 'volume':
                  cellContent = value || '-';
                  break;
                  
                case 'volume环比':
                  if (value) {
                    const diff = value.diff.toFixed(1);
                    const rate = `${(value.rate * 100).toFixed(1)}%`;
                    const isUp = value.diff > 0;
                    cellContent = `<span class="${isUp ? 'compare-up' : 'compare-down'}">${isUp ? '↑' : '↓'}${diff} (${rate})</span>`;
                  }
                  break;
                  
                case 'satisfaction':
                  if (value) {
                    const satisfactionValue = row[`${week}_满意度_原始值`] * 100;
                    const isAboveTarget = satisfactionValue >= satisfactionTarget;
                    cellContent = `<span class="${isAboveTarget ? 'text-success' : 'text-danger'}">${value}</span>`;
                  }
                  break;
                  
                case 'satisfaction环比':
                  if (value) {
                    const rate = `${(value.rate * 100).toFixed(1)}%`;
                    const isUp = value.diff > 0;
                    cellContent = `<span class="${isUp ? 'compare-up' : 'compare-down'}">${isUp ? '↑' : '↓'}${value.displayDiff} (${rate})</span>`;
                  }
                  break;
                  
                case 'satisfaction样本量':
                  cellContent = value || '-';
                  break;
                  
                case 'satisfaction样本量环比':
                  if (value) {
                    const diff = value.diff.toFixed(1);
                    const rate = `${(value.rate * 100).toFixed(1)}%`;
                    const isUp = value.diff > 0;
                    cellContent = `<span class="${isUp ? 'compare-up' : 'compare-down'}">${isUp ? '↑' : '↓'}${diff} (${rate})</span>`;
                  }
                  break;
                  
                case 'satisfaction影响值':
                  cellContent = value !== undefined ? formatImpactValue(value) : '-';
                  break;
                  
                case 'satisfaction影响值环比':
                  if (value) {
                    const rate = `${(value.rate * 100).toFixed(1)}%`;
                    const isUp = value.diff > 0;
                    cellContent = `<span class="${isUp ? 'compare-up' : 'compare-down'}">${isUp ? '↑' : '↓'}${value.displayDiff} (${rate})</span>`;
                  }
                  break;
                  
                case 'resolution':
                  if (value) {
                    const resolutionValue = row[`${week}_解决率_原始值`] * 100;
                    const isAboveTarget = resolutionValue >= resolutionTarget;
                    cellContent = `<span class="${isAboveTarget ? 'text-success' : 'text-danger'}">${value}</span>`;
                  }
                  break;
                  
                case 'resolution环比':
                  if (value) {
                    const rate = `${(value.rate * 100).toFixed(1)}%`;
                    const isUp = value.diff > 0;
                    cellContent = `<span class="${isUp ? 'compare-up' : 'compare-down'}">${isUp ? '↑' : '↓'}${value.displayDiff} (${rate})</span>`;
                  }
                  break;
                  
                case 'resolution样本量':
                  if (value !== undefined && value !== '-') {
                    const isAboveTarget = value >= resolutionSampleTarget;
                    cellContent = `<span class="${isAboveTarget ? 'text-success' : 'text-danger'} font-medium">${value}</span>`;
                  }
                  break;
                  
                case 'resolution样本量环比':
                  if (value) {
                    const diff = value.diff.toFixed(1);
                    const rate = `${(value.rate * 100).toFixed(1)}%`;
                    const isUp = value.diff > 0;
                    cellContent = `<span class="${isUp ? 'compare-up' : 'compare-down'}">${isUp ? '↑' : '↓'}${diff} (${rate})</span>`;
                  }
                  break;
                  
                case 'resolution影响值':
                  cellContent = value !== undefined ? formatImpactValue(value) : '-';
                  break;
                  
                case 'resolution影响值环比':
                  if (value) {
                    const rate = `${(value.rate * 100).toFixed(1)}%`;
                    const isUp = value.diff > 0;
                    cellContent = `<span class="${isUp ? 'compare-up' : 'compare-down'}">${isUp ? '↑' : '↓'}${value.displayDiff} (${rate})</span>`;
                  }
                  break;
              }
              
              rowHtml += `<td class="px-3 py-2 text-sm text-gray-700 whitespace-nowrap ${weekClass}" data-week="${week}">${cellContent}</td>`;
            });
        });
        
        rowHtml += `</tr>`;
        bodyHtml += rowHtml;
      });
      
      elements.resultTableBody.innerHTML = bodyHtml;
      
      // 显示结果区域
      elements.resultSection.style.display = 'block';
      
      // 生成并显示组别维度报表
      generateGroupReportData();
      populateGroupReportFilterOptions();
      applyGroupReportFilter();
      elements.groupReportSection.style.display = 'block';
      
      // 更新切换按钮文本
      updateToggleButtonText();
      
      // 在下一个渲染周期更新sticky列位置，确保表格内容已完全渲染
      setTimeout(updateStickyColumnPositions, 0);
    }

    // 更新切换按钮文本
    function updateToggleButtonText() {
      if (showAllWeeks) {
        elements.toggleWeeksBtn.innerHTML = '<i class="fa fa-chevron-up mr-1"></i>折叠早期数据';
      } else {
        elements.toggleWeeksBtn.innerHTML = '<i class="fa fa-chevron-down mr-1"></i>展开全部';
      }
    }

    // 切换周数据显示
    function toggleWeeksDisplay() {
      showAllWeeks = !showAllWeeks;
      displayResultData(appData.currentWeeks);
    }

    // 导出结果数据（基于核心字段组的可见性）
    function exportResultData() {
      if (appData.filteredResultData.length === 0) {
        showNotification('没有可导出的数据', 'warning');
        return;
      }
      
      showLoading('正在准备导出文件...');
      
      try {
        // 准备导出数据（跟随核心字段组的显示状态）
        const exportData = appData.filteredResultData.map(row => {
          const exportRow = {};
          
          // 处理基础信息组
          const baseGroup = appData.coreFieldGroups.find(g => g.key === 'base');
          if (baseGroup && appData.headerVisibility[baseGroup.key]) {
            baseGroup.fields.forEach(field => {
              exportRow[field] = row[field] || '';
            });
          }
          
          // 处理每周的核心字段组
          appData.currentWeeks.forEach(week => {
            const weekNum = week.split('W')[1];
            
            appData.coreFieldGroups
              .filter(g => g.key !== 'base' && g.fieldTemplate && appData.headerVisibility[g.key])
              .forEach(group => {
                const field = group.fieldTemplate.replace('${week}', week);
                const value = row[field];
                const label = `${week}_${group.label}`;
                
                // 处理不同类型的字段值
                if (group.key.includes('环比') && value && typeof value === 'object') {
                  if ('displayDiff' in value) {
                    exportRow[`${label}_变化量`] = value.displayDiff;
                  } else {
                    exportRow[`${label}_变化量`] = value.diff.toFixed(1);
                  }
                  exportRow[`${label}_变化率`] = `${(value.rate * 100).toFixed(1)}%`;
                } else {
                  exportRow[label] = value !== undefined ? value : '';
                }
              });
          });
          
          return exportRow;
        });
        
        // 创建工作簿并导出
        const worksheet = XLSX.utils.json_to_sheet(exportData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, '绩效分析结果');
        
        // 生成包含当前日期的文件名
        const date = new Date();
        const formattedDate = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
        const fileName = `绩效分析结果_${formattedDate}.xlsx`;
        
        XLSX.writeFile(workbook, fileName);
        showNotification('数据导出成功', 'success');
      } catch (error) {
        console.error('导出数据失败：', error);
        showNotification('文件导出失败，请重试', 'error');
      } finally {
        hideLoading();
      }
    }

    // 显示通知
    function showNotification(message, type = 'info') {
      const notification = elements.notification;
      notification.textContent = message;
      
      // 设置通知类型样式
      notification.className = 'fixed bottom-4 right-4 px-4 py-3 rounded-md shadow-lg transform translate-y-0 opacity-100 transition-all duration-300 flex items-center max-w-xs';
      
      switch(type) {
        case 'success':
          notification.classList.add('bg-success', 'text-white');
          notification.innerHTML = `<i class="fa fa-check-circle mr-2"></i>${message}`;
          break;
        case 'error':
          notification.classList.add('bg-danger', 'text-white');
          notification.innerHTML = `<i class="fa fa-exclamation-circle mr-2"></i>${message}`;
          break;
        case 'warning':
          notification.classList.add('bg-warning', 'text-white');
          notification.innerHTML = `<i class="fa fa-warning mr-2"></i>${message}`;
          break;
        default:
          notification.classList.add('bg-primary', 'text-white');
          notification.innerHTML = `<i class="fa fa-info-circle mr-2"></i>${message}`;
      }
      
      // 3秒后隐藏通知
      setTimeout(() => {
        notification.classList.remove('translate-y-0', 'opacity-100');
        notification.classList.add('translate-y-20', 'opacity-0');
      }, 3000);
    }
    
    // 组别维度报表相关函数
    let groupReportData = [];
    let filteredGroupReportData = [];
    let uniqueDepts = [];
    let uniqueGroups = new Map();
    
    // 生成组别维度报表数据
    function generateGroupReportData() {
      // 获取目标值
      const satisfactionTarget = parseFloat(elements.satisfactionTarget.value) || 83.5;
      const resolutionTarget = parseFloat(elements.resolutionTarget.value) || 70;
      
      // 按五级部门和组别汇总数据
      const groupMap = new Map();
      
      // 收集所有唯一的五级部门和组别信息
      uniqueDepts = new Set();
      uniqueGroups = new Map();
      
      // 为每个员工处理数据，确保所有计算都以组别字段为基准
      Object.values(appData.resultData).forEach(employee => {
        // 优先通过客服账号匹配花名单获取所属行政处作为组别
        const staffInfo = appData.staffData.find(staff => staff['账号'] === employee['客服账号']);
        const groupName = staffInfo && staffInfo['所属行政处'] ? staffInfo['所属行政处'] : (employee['组别'] || '未分组');
        
        // 获取部门信息
        let deptName = employee['五级部门'] || '未分组';
        
        // 构建组别键值
        const groupKey = `${deptName}_${groupName}`;
        
        // 收集部门和组别信息
        uniqueDepts.add(deptName);
        if (!uniqueGroups.has(deptName)) {
          uniqueGroups.set(deptName, new Set());
        }
        uniqueGroups.get(deptName).add(groupName);
        
        // 初始化或获取组数据对象
        if (!groupMap.has(groupKey)) {
          groupMap.set(groupKey, {
            五级部门: deptName,
            组别: groupName,
            周数据: {}
          });
        }
        
        const groupItem = groupMap.get(groupKey);
        
        // 遍历所有周数据，累加员工指标到对应组别
        appData.currentWeeks.forEach(week => {
          // 初始化周数据对象（如果不存在）
          if (!groupItem.周数据[week]) {
            groupItem.周数据[week] = {
              接待量: 0,
              满意量_剔除R: 0,
              评价量_剔除R: 0,
              已解决量_剔除R: 0,
              解决率总评价量_剔除R: 0
            };
          }
          
          // 获取员工该周的数据
          const 接待量 = employee[`${week}_接待量`] || 0;
          const 满意量_剔除R = employee[`${week}_满意量_剔除R`] || 0;
          const 评价量_剔除R = employee[`${week}_评价量_剔除R`] || 0;
          const 已解决量_剔除R = employee[`${week}_已解决量_剔除R`] || 0;
          const 解决率总评价量_剔除R = employee[`${week}_解决率总评价量_剔除R`] || 0;
          
          // 累加数据到对应组别
          groupItem.周数据[week].接待量 += 接待量;
          groupItem.周数据[week].满意量_剔除R += 满意量_剔除R;
          groupItem.周数据[week].评价量_剔除R += 评价量_剔除R;
          groupItem.周数据[week].已解决量_剔除R += 已解决量_剔除R;
          groupItem.周数据[week].解决率总评价量_剔除R += 解决率总评价量_剔除R;
        });
      });
      
      // 计算每周总的评价量和解决率评价量（用于影响值计算）
      const weeklyTotals = {};
      appData.currentWeeks.forEach(week => {
        weeklyTotals[week] = {
          totalEvaluation: 0,
          totalResolutionEvaluation: 0
        };
        
        // 遍历所有员工数据，累加评价量
        Object.values(appData.resultData).forEach(employee => {
          weeklyTotals[week].totalEvaluation += employee[`${week}_评价量_剔除R`] || 0;
          weeklyTotals[week].totalResolutionEvaluation += employee[`${week}_解决率总评价量_剔除R`] || 0;
        });
      });
      
      // 确保数据完整，为每个组别初始化所有周的数据
      appData.currentWeeks.forEach(week => {
        Array.from(groupMap.values()).forEach(groupItem => {
          if (!groupItem.周数据[week]) {
            groupItem.周数据[week] = {
              接待量: 0,
              满意量_剔除R: 0,
              评价量_剔除R: 0,
              已解决量_剔除R: 0,
              解决率总评价量_剔除R: 0
            };
          }
        });
      });
      
      // 计算每个组别的详细指标
      groupReportData = Array.from(groupMap.values()).map(groupItem => {
        const processedGroup = { 
          五级部门: groupItem.五级部门,
          组别: groupItem.组别 
        };
        
        // 按周排序以便计算环比
        const sortedWeeks = [...appData.currentWeeks].sort((a, b) => a.localeCompare(b));
        
        sortedWeeks.forEach((week, index) => {
          const weekData = groupItem.周数据[week];
          const totals = weeklyTotals[week];
          
          // 计算满意度：当周对应组别满意量_剔除R之和/当周对应组别评价量_剔除R之和
          const satisfactionRate = weekData.评价量_剔除R > 0 ? (weekData.满意量_剔除R / weekData.评价量_剔除R * 100) : 0;
          
          // 计算满意度影响值：（小组满意度-满意度_剔除R目标值）*（当周组别评价量_剔除R 总数量/当周所有评价量_剔除R 总数量）
          let satisfactionImpact = 0;
          if (totals.totalEvaluation > 0 && weekData.评价量_剔除R > 0) {
            satisfactionImpact = ((satisfactionRate / 100) - (satisfactionTarget / 100)) * 
                                (weekData.评价量_剔除R / totals.totalEvaluation);
          }
          
          // 计算解决率
          const resolutionRate = weekData.解决率总评价量_剔除R > 0 ? (weekData.已解决量_剔除R / weekData.解决率总评价量_剔除R * 100) : 0;
          
          // 计算解决率影响值
          let resolutionImpact = 0;
          if (totals.totalResolutionEvaluation > 0 && weekData.解决率总评价量_剔除R > 0) {
            resolutionImpact = ((resolutionRate / 100) - (resolutionTarget / 100)) * 
                              (weekData.解决率总评价量_剔除R / totals.totalResolutionEvaluation);
          }
          
          // 添加到处理后的组数据中
          processedGroup[`${week}小组接待量`] = weekData.接待量;
          processedGroup[`${week}小组满意度`] = satisfactionRate;
          processedGroup[`${week}小组满意度样本量`] = weekData.评价量_剔除R;
          processedGroup[`${week}小组满意度影响值`] = satisfactionImpact;
          processedGroup[`${week}小组解决率`] = resolutionRate;
          processedGroup[`${week}小组解决率样本量`] = weekData.解决率总评价量_剔除R;
          processedGroup[`${week}小组解决率影响值`] = resolutionImpact;
          
          // 计算与上一周的环比数据（如果不是第一周）
          if (index > 0) {
            const prevWeek = sortedWeeks[index - 1];
            const prevWeekData = groupItem.周数据[prevWeek];
            
            // 接待量环比
            const volumeDiff = weekData.接待量 - prevWeekData.接待量;
            const volumeRate = prevWeekData.接待量 > 0 ? (volumeDiff / prevWeekData.接待量) : (weekData.接待量 > 0 ? 1 : 0);
            processedGroup[`${week}小组接待量环比`] = {
              diff: volumeDiff,
              rate: volumeRate,
              displayDiff: volumeDiff.toFixed(1)
            };
            
            // 满意度环比
            const prevSatisfactionRate = prevWeekData.评价量_剔除R > 0 ? (prevWeekData.满意量_剔除R / prevWeekData.评价量_剔除R * 100) : 0;
            const satisfactionDiff = satisfactionRate - prevSatisfactionRate;
            const satisfactionRatePercent = prevSatisfactionRate > 0 ? (satisfactionDiff / prevSatisfactionRate) : (satisfactionRate > 0 ? 1 : 0);
            processedGroup[`${week}小组满意度环比`] = {
              diff: satisfactionDiff,
              rate: satisfactionRatePercent,
              displayDiff: satisfactionDiff.toFixed(2) + '%'
            };
            
            // 满意度影响值环比
            let prevSatisfactionImpact = 0;
            const prevTotals = weeklyTotals[prevWeek];
            if (prevTotals && prevTotals.totalEvaluation > 0 && prevWeekData.评价量_剔除R > 0) {
              prevSatisfactionImpact = ((prevSatisfactionRate / 100) - (satisfactionTarget / 100)) * 
                                      (prevWeekData.评价量_剔除R / prevTotals.totalEvaluation);
            }
            const satisfactionImpactDiff = satisfactionImpact - prevSatisfactionImpact;
            const satisfactionImpactRate = Math.abs(prevSatisfactionImpact) > 0 ? 
                                          (satisfactionImpactDiff / prevSatisfactionImpact) : 
                                          (Math.abs(satisfactionImpact) > 0 ? 1 : 0);
            processedGroup[`${week}小组满意度影响值环比`] = {
              diff: satisfactionImpactDiff,
              rate: satisfactionImpactRate,
              displayDiff: formatImpactValue(satisfactionImpactDiff)
            };
            
            // 解决率环比
            const prevResolutionRate = prevWeekData.解决率总评价量_剔除R > 0 ? (prevWeekData.已解决量_剔除R / prevWeekData.解决率总评价量_剔除R * 100) : 0;
            const resolutionDiff = resolutionRate - prevResolutionRate;
            const resolutionRatePercent = prevResolutionRate > 0 ? (resolutionDiff / prevResolutionRate) : (resolutionRate > 0 ? 1 : 0);
            processedGroup[`${week}小组解决率环比`] = {
              diff: resolutionDiff,
              rate: resolutionRatePercent,
              displayDiff: resolutionDiff.toFixed(2) + '%'
            };
            
            // 解决率影响值环比
            let prevResolutionImpact = 0;
            if (prevTotals && prevTotals.totalResolutionEvaluation > 0 && prevWeekData.解决率总评价量_剔除R > 0) {
              prevResolutionImpact = ((prevResolutionRate / 100) - (resolutionTarget / 100)) * 
                                    (prevWeekData.解决率总评价量_剔除R / prevTotals.totalResolutionEvaluation);
            }
            const resolutionImpactDiff = resolutionImpact - prevResolutionImpact;
            const resolutionImpactRate = Math.abs(prevResolutionImpact) > 0 ? 
                                        (resolutionImpactDiff / prevResolutionImpact) : 
                                        (Math.abs(resolutionImpact) > 0 ? 1 : 0);
            processedGroup[`${week}小组解决率影响值环比`] = {
              diff: resolutionImpactDiff,
              rate: resolutionImpactRate,
              displayDiff: formatImpactValue(resolutionImpactDiff)
            };
          }
        });
        
        return processedGroup;
      });
    }
    
    // 填充组别报表筛选选项
    function populateGroupReportFilterOptions() {
      // 清空现有选项
      elements.groupReportDeptFilter.innerHTML = '<option value="">全部五级部门</option>';
      elements.groupReportGroupFilter.innerHTML = '<option value="">全部组别</option>';
      
      // 填充部门选项
      uniqueDepts = Array.from(uniqueDepts).sort();
      uniqueDepts.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept;
        option.textContent = dept;
        elements.groupReportDeptFilter.appendChild(option);
      });
      
      // 默认显示所有组别
      const allGroups = new Set();
      uniqueGroups.forEach(groups => {
        groups.forEach(group => allGroups.add(group));
      });
      
      Array.from(allGroups).sort().forEach(group => {
        const option = document.createElement('option');
        option.value = group;
        option.textContent = group;
        elements.groupReportGroupFilter.appendChild(option);
      });
    }
    
    // 根据选定的部门更新组别选项
    function updateGroupReportGroupOptions() {
      const selectedDept = elements.groupReportDeptFilter.value;
      
      // 清空现有组别选项
      elements.groupReportGroupFilter.innerHTML = '<option value="">全部组别</option>';
      
      if (selectedDept === '') {
        // 如果选择全部部门，显示所有组别
        const allGroups = new Set();
        uniqueGroups.forEach(groups => {
          groups.forEach(group => allGroups.add(group));
        });
        
        Array.from(allGroups).sort().forEach(group => {
          const option = document.createElement('option');
          option.value = group;
          option.textContent = group;
          elements.groupReportGroupFilter.appendChild(option);
        });
      } else {
        // 显示选定部门下的组别
        const groups = uniqueGroups.get(selectedDept) || new Set();
        Array.from(groups).sort().forEach(group => {
          const option = document.createElement('option');
          option.value = group;
          option.textContent = group;
          elements.groupReportGroupFilter.appendChild(option);
        });
      }
    }
    
    // 应用组别报表筛选
    function applyGroupReportFilter() {
      const deptFilter = elements.groupReportDeptFilter.value;
      const groupFilter = elements.groupReportGroupFilter.value;
      
      // 应用筛选条件
      filteredGroupReportData = groupReportData.filter(item => {
        const matchDept = deptFilter === '' || item['五级部门'] === deptFilter;
        const matchGroup = groupFilter === '' || item['组别'] === groupFilter;
        return matchDept && matchGroup;
      });
      
      // 显示筛选后的结果
      displayGroupReportData(filteredGroupReportData);
    }
    
    // 重置组别报表筛选
    function resetGroupReportFilter() {
      elements.groupReportDeptFilter.value = '';
      elements.groupReportGroupFilter.value = '';
      updateGroupReportGroupOptions();
      applyGroupReportFilter();
    }
    
    // 显示组别维度报表数据
    function displayGroupReportData(dataToDisplay) {
      let data = dataToDisplay || filteredGroupReportData || [];
      
      if (data.length === 0) {
        elements.groupReportEmptyState.style.display = 'flex';
        return;
      }
      
      elements.groupReportEmptyState.style.display = 'none';
      
      // 获取最新的周
      const sortedWeeks = [...appData.currentWeeks].sort((a, b) => a.localeCompare(b));
      const latestWeek = sortedWeeks[sortedWeeks.length - 1];
      
      // 按最新周的小组接待量从大到小排序
      data = data.sort((a, b) => {
        const aVolume = a[`${latestWeek}小组接待量`] || 0;
        const bVolume = b[`${latestWeek}小组接待量`] || 0;
        return bVolume - aVolume;
      });
      
      // 生成表头
      const headers = ['五级部门', '组别'];
      
      sortedWeeks.forEach(week => {
        headers.push(`${week}小组接待量`);
        headers.push(`${week}小组接待量环比`);
        headers.push(`${week}小组满意度`);
        headers.push(`${week}小组满意度环比`);
        headers.push(`${week}小组满意度样本量`);
        headers.push(`${week}小组满意度影响值`);
        headers.push(`${week}小组满意度影响值环比`);
        headers.push(`${week}小组解决率`);
        headers.push(`${week}小组解决率环比`);
        headers.push(`${week}小组解决率样本量`);
        headers.push(`${week}小组解决率影响值`);
        headers.push(`${week}小组解决率影响值环比`);
      });
      
      // 清空表头
      elements.groupReportTableHeader.innerHTML = '';
      
      // 添加表头单元格
      headers.forEach((headerText, index) => {
        const th = document.createElement('th');
        // 为所有表头添加sticky top-0确保上下滚动时表头固定
        if (headerText === '五级部门') {
          th.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap sticky top-0 left-0 bg-gray-50 z-20 border-r border-gray-200';
        } else if (headerText === '组别') {
          th.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap sticky top-0 left-[160px] bg-gray-50 z-20 border-r border-gray-200';
        } else {
          th.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap sticky top-0 bg-gray-50 z-10';
        }
        th.textContent = headerText;
        elements.groupReportTableHeader.appendChild(th);
      });
      
      // 清空表格内容
      elements.groupReportTableBody.innerHTML = '';
      
      // 添加表格行
      data.forEach(groupItem => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        
        headers.forEach((header, index) => {
            const td = document.createElement('td');
            // 为五级部门和组别列添加粘性定位
            if (header === '五级部门') {
              td.className = 'px-4 py-3 whitespace-nowrap text-sm sticky left-0 bg-white z-10 border-r border-gray-200';
            } else if (header === '组别') {
              td.className = 'px-4 py-3 whitespace-nowrap text-sm sticky left-[160px] bg-white z-10 border-r border-gray-200';
            } else {
              td.className = 'px-4 py-3 whitespace-nowrap text-sm';
            }
          
          let value = groupItem[header];
          
          if (value === undefined || value === null) {
            td.textContent = '-';
          } else if (typeof value === 'object' && header.includes('环比')) {
            // 格式化对象类型的环比数据（与绩效分析结果格式一致）
            const isUp = value.diff > 0;
            const rate = `${(value.rate * 100).toFixed(2)}%`;
            const diffValue = value.displayDiff || value.diff.toFixed(2);
            
            // 设置环比颜色样式
            const className = isUp ? 'compare-up' : (value.diff < 0 ? 'compare-down' : '');
            
            // 带箭头的环比显示格式：箭头+变化量 (变化率%)
            // 为满意度环比和解决率环比的变化量添加百分号
            let formattedDiffValue = diffValue;
            if ((header.includes('小组满意度环比') || header.includes('小组解决率环比')) && !diffValue.includes('%')) {
              formattedDiffValue = diffValue + '%';
            }
            td.innerHTML = `<span class="${className}">${isUp ? '↑' : (value.diff < 0 ? '↓' : '')}${formattedDiffValue} (${rate})</span>`;
          } else if (typeof value === 'number') {
            // 根据字段类型格式化显示
            if (header.includes('满意度') && !header.includes('样本量') && !header.includes('影响值')) {
              td.textContent = value.toFixed(2) + '%';
            } else if (header.includes('解决率') && !header.includes('样本量') && !header.includes('影响值')) {
              td.textContent = value.toFixed(2) + '%';
            } else if (header.includes('影响值')) {
              td.textContent = formatImpactValue(value);
              if (value > 0) {
                td.className += ' text-success';
              } else if (value < 0) {
                td.className += ' text-danger';
              }
            } else {
              td.textContent = value;
            }
          } else {
            td.textContent = value;
          }
          
          tr.appendChild(td);
        });
        
        elements.groupReportTableBody.appendChild(tr);
      });
    }
    
    // 导出组别维度报表数据
    function exportGroupReportData() {
      if (filteredGroupReportData.length === 0) {
        showNotification('暂无组别数据可导出', 'warning');
        return;
      }
      
      showLoading('正在准备导出文件...');
      
      try {
        // 准备导出数据（跟随筛选结果）
        const exportData = filteredGroupReportData.map(groupItem => {
          const exportRow = { 
            五级部门: groupItem['五级部门'],
            组别: groupItem['组别']
          };
          
          Object.keys(groupItem).forEach(key => {
            if (key !== '五级部门' && key !== '组别') {
              let value = groupItem[key];
              
              // 处理环比数据对象（包含diff、rate和displayDiff属性）
              if (typeof value === 'object' && value !== null && 'displayDiff' in value) {
                // 使用displayDiff属性作为显示值，这是我们格式化后的值
                exportRow[key] = value.displayDiff;
              } 
              // 处理数值类型数据
              else if (typeof value === 'number') {
                // 格式化数字
                if (key.includes('满意度') && !key.includes('样本量') && !key.includes('影响值')) {
                  exportRow[key] = value.toFixed(2) + '%';
                } else if (key.includes('解决率') && !key.includes('样本量') && !key.includes('影响值')) {
                  exportRow[key] = value.toFixed(2) + '%';
                } else if (key.includes('影响值')) {
                  exportRow[key] = (value * 100).toFixed(5) + '%';
                } else {
                  exportRow[key] = value;
                }
              } else {
                exportRow[key] = value;
              }
            }
          });
          
          return exportRow;
        });
        
        // 创建工作簿和工作表
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, '组别维度报表');
        
        // 生成文件名
        const date = new Date();
        const formattedDate = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
        const fileName = `组别维度报表_${appData.latestWeek}_${formattedDate}.xlsx`;
        
        // 导出文件
        XLSX.writeFile(wb, fileName);
        
        showNotification('组别数据导出成功！', 'success');
      } catch (error) {
        console.error('导出组别数据失败：', error);
        showNotification('文件导出失败，请重试', 'error');
      } finally {
        hideLoading();
      }
    }

    // 初始化应用
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>